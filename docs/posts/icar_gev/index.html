<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Brynjólfur Gauti Guðrúnar Jónsson">
<meta name="dcterms.date" content="2024-02-06">

<title>bggj - Spatially Dependent Generalized Extreme Value Parameters</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EGQ9KVCY2C"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EGQ9KVCY2C', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="bggj - Spatially Dependent Generalized Extreme Value Parameters">
<meta property="og:description" content="Using Stan to fit a Generalized Extreme Value Distribution with spatially dependent parameters">
<meta property="og:image" content="https://www.bggj.is/posts/icar_gev/Figures/cover.png">
<meta property="og:site_name" content="bggj">
<meta property="og:image:height" content="3120">
<meta property="og:image:width" content="3120">
<meta name="twitter:title" content="bggj - Spatially Dependent Generalized Extreme Value Parameters">
<meta name="twitter:description" content="Using Stan to fit a Generalized Extreme Value Distribution with spatially dependent parameters">
<meta name="twitter:image" content="https://www.bggj.is/posts/icar_gev/Figures/cover.png">
<meta name="twitter:creator" content="@bggjonsson">
<meta name="twitter:site" content="@bggjonsson">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="3120">
<meta name="twitter:image-width" content="3120">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">bggj</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../phd/index.html"> 
<span class="menu-text">phd</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/bggjonsson"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bgautijonsson/bgautijonsson.github.io"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Spatially Dependent Generalized Extreme Value Parameters</h1>
            <p class="subtitle lead">Using Stan to fit a Generalized Extreme Value Distribution with spatially dependent parameters</p>
                                <div class="quarto-categories">
                <div class="quarto-category">english</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">phd</div>
                <div class="quarto-category">stan</div>
                <div class="quarto-category">bayesian</div>
                <div class="quarto-category">spatial statistics</div>
                <div class="quarto-category">hierarchical modeling</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="bggj.is">Brynjólfur Gauti Guðrúnar Jónsson</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://www.hi.is/tolfraedi_0">
              Tölfræði, Raunvísindadeild Háskóla Íslands
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 6, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#extreme-value-statistics" id="toc-extreme-value-statistics" class="nav-link" data-scroll-target="#extreme-value-statistics">Extreme Value Statistics</a></li>
  <li><a href="#spatial-statistics" id="toc-spatial-statistics" class="nav-link" data-scroll-target="#spatial-statistics">Spatial Statistics</a>
  <ul class="collapse">
  <li><a href="#conditional-autoregression-car-models" id="toc-conditional-autoregression-car-models" class="nav-link" data-scroll-target="#conditional-autoregression-car-models">Conditional Autoregression (CAR) Models</a></li>
  <li><a href="#intrinsic-conditional-autoregression-icar-models" id="toc-intrinsic-conditional-autoregression-icar-models" class="nav-link" data-scroll-target="#intrinsic-conditional-autoregression-icar-models">Intrinsic Conditional Autoregression (ICAR) Models</a></li>
  <li><a href="#besag-york-mollié-bym-model" id="toc-besag-york-mollié-bym-model" class="nav-link" data-scroll-target="#besag-york-mollié-bym-model">Besag York Mollié (BYM) Model</a></li>
  <li><a href="#bym2-model" id="toc-bym2-model" class="nav-link" data-scroll-target="#bym2-model">BYM2 Model</a></li>
  </ul></li>
  <li><a href="#copulas" id="toc-copulas" class="nav-link" data-scroll-target="#copulas">Copulas</a></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#subset-of-the-data" id="toc-subset-of-the-data" class="nav-link" data-scroll-target="#subset-of-the-data">Subset of the data</a>
  <ul class="collapse">
  <li><a href="#stations" id="toc-stations" class="nav-link" data-scroll-target="#stations">Stations</a></li>
  <li><a href="#precipitation" id="toc-precipitation" class="nav-link" data-scroll-target="#precipitation">Precipitation</a></li>
  </ul></li>
  <li><a href="#prepare-the-data-for-stan" id="toc-prepare-the-data-for-stan" class="nav-link" data-scroll-target="#prepare-the-data-for-stan">Prepare the data for Stan</a></li>
  </ul></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#bym2-parameters" id="toc-bym2-parameters" class="nav-link" data-scroll-target="#bym2-parameters">BYM2 Parameters</a></li>
  <li><a href="#spatial-distribution" id="toc-spatial-distribution" class="nav-link" data-scroll-target="#spatial-distribution">Spatial Distribution</a>
  <ul class="collapse">
  <li><a href="#unconstrained-scale" id="toc-unconstrained-scale" class="nav-link" data-scroll-target="#unconstrained-scale">Unconstrained Scale</a></li>
  <li><a href="#constrained-scale" id="toc-constrained-scale" class="nav-link" data-scroll-target="#constrained-scale">Constrained Scale</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p><strong>Note:</strong> I’m still working on this post, but I thought I might put it out there while I work on it.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bggjphd)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leafsync)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bggj</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="introduction" class="level1 page-columns page-full">
<h1>Introduction</h1>
<p>My PhD research is mostly about three things:</p>
<ul>
<li>Extreme Value Statistics</li>
<li>Spatial Statistics</li>
<li>Copulas</li>
</ul>
<p>In this post I will write a little about the first two.</p>
<section id="extreme-value-statistics" class="level2">
<h2 class="anchored" data-anchor-id="extreme-value-statistics">Extreme Value Statistics</h2>
<p>Up until now I have mostly been working with the generalized extreme value distribution. The cumulative distribution function of the Generalized Extreme Value distribution is</p>
<p><span class="math display">\[
\mathrm{GEV}(y \vert \mu, \sigma, \xi) = \begin{cases}
\begin{aligned}
&amp;e^{- \left(1 + \xi \frac{y - \mu}{\sigma}\right)_+^{-1/\xi}}, \quad &amp;\xi \neq 0 \\
&amp;e^{-e^{- \frac{y - \mu}{\sigma}}}, \qquad &amp;\xi = 0
\end{aligned}
\end{cases}
\]</span></p>
<p>The log-likelihood of the GEV distribution is</p>
<p><span class="math display">\[
\ell(\mu, \sigma, \xi) = - n\log\sigma - (1 + \frac{1}{\xi}) \sum_{i=1}^{n}{\log\left(1 + \xi\left[\frac{z_i - \mu}{\sigma} \right]\right)} - \sum_{i=1}^{n}{\left(1 + \xi \left[ \frac{z_i - \mu}{\sigma} \right]\right)}^{-1/\xi},
\]</span></p>
<p>provided that <span class="math inline">\(1 + \xi\left( \frac{z_i - \mu}{\sigma} \right) &gt; 0\)</span>. Instead of <span class="math inline">\(\mu\)</span> I will be using the parameter <span class="math inline">\(\mu_t\)</span> where</p>
<p><span class="math display">\[
\mu_t = \mu_0 \cdot (1 + \Delta(t - t_0)) = \mu_0 + \Delta(t - t_0) \cdot \mu_0.
\]</span></p>
<p>We thus estimate two parameters that are related to the location of the GEV distribution, <span class="math inline">\(\mu_0\)</span> and <span class="math inline">\(\Delta\)</span>.</p>
</section>
<section id="spatial-statistics" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="spatial-statistics">Spatial Statistics</h2>
<p>In our formulation, the GEV distribution has four parameters:</p>
<ul>
<li><span class="math inline">\(\mu\)</span>: Location</li>
<li><span class="math inline">\(\sigma\)</span>: Scale</li>
<li><span class="math inline">\(\xi\)</span>: Shape</li>
<li><span class="math inline">\(\Delta\)</span>: Trend</li>
</ul>
<p>You could also just say that there are three parameters and that we’re using a linear model to allow a trend in the location parameter, but we’ll keep this wording for now.</p>
<p>I will be fitting a GEV distribution to each area in the <a href="https://bggj.is/posts/ceda-archive/">CEDA Archived data I’ve written about before</a>. It’s logical to assume that these areas are not completely independent and that there is some sort of spatial dependency, i.e.&nbsp;that all other things being equal; areas that are near each other are more similar that areas that are far away from each other.</p>
<p>We could apply a model structure based on the distance between points, but we will end up having a lot of areas <em>(around 40,000 or so)</em>, so we need a spatial model that allows for sparsity in the spatial dependence.</p>
<p>One way to do this is to model the areas as jointly multivariate normal distributed with a sparse precision matrix. Precision matrices can be better than covariance matrices for this type of modeling since the off-diagonal elements in a precision matrix stand for conditional dependencies.</p>
<p>More formally, let <span class="math inline">\(\mathbf x\)</span> be multivariate normal distributed with mean <span class="math inline">\(\boldsymbol \mu\)</span> and semi positive definite precision matrix <span class="math inline">\(\mathbf Q\)</span>. Then for <span class="math inline">\(i \neq j\)</span></p>
<p><span class="math display">\[
x_i \perp x_j \vert \mathbf x_{-ij} \iff Q_{ij} = 0.
\]</span></p>
<p>This means that any two elements in <span class="math inline">\(\mathbf x\)</span> are conditionally independent conditional on the other elements of <span class="math inline">\(\mathbf x\)</span> if and only if the corresponding value in the precision matrix <span class="math inline">\(\mathbf Q\)</span> is zero. For further reading see <span class="citation" data-cites="rueGaussianMarkovRandom2005">Rue and Held (<a href="#ref-rueGaussianMarkovRandom2005" role="doc-biblioref">2005</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-rueGaussianMarkovRandom2005" class="csl-entry" role="listitem">
Rue, Havard, and Leonhard Held. 2005. <em>Gaussian <span>Markov Random Fields</span>: <span>Theory</span> and <span>Applications</span></em>. <span>CRC Press</span>.
</div></div><p>We can easily use this to our advantage so that our precision matrix becomes very sparse. For example we might set <span class="math inline">\(Q_{ij} \neq 0\)</span> only if <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are neighbors on our map.</p>
<p>The rest of this chapter on spatial statistics is based heavily on the paper by <span class="citation" data-cites="morrisBayesianHierarchicalSpatial2019">Morris et al. (<a href="#ref-morrisBayesianHierarchicalSpatial2019" role="doc-biblioref">2019</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-morrisBayesianHierarchicalSpatial2019" class="csl-entry" role="listitem">
Morris, Mitzi, Katherine Wheeler-Martin, Dan Simpson, Stephen J. Mooney, Andrew Gelman, and Charles DiMaggio. 2019. <span>“Bayesian Hierarchical Spatial Models: <span>Implementing</span> the <span>Besag York Mollié</span> Model in Stan.”</span> <em>Spatial and Spatio-Temporal Epidemiology</em> 31 (November): 100301. <a href="https://doi.org/10.1016/j.sste.2019.100301">https://doi.org/10.1016/j.sste.2019.100301</a>.
</div></div><section id="conditional-autoregression-car-models" class="level3">
<h3 class="anchored" data-anchor-id="conditional-autoregression-car-models">Conditional Autoregression (CAR) Models</h3>
<p>In a CAR prior, the prior distribution of <span class="math inline">\(x_i\)</span> given its neighbors can be written</p>
<p><span class="math display">\[
x_i \vert x_{-i} \sim \mathrm{Normal}\left( \sum_{j\in S_i} w_{ij}x_j, \sigma^2 \right),
\]</span></p>
<p>where <span class="math inline">\(x_{-i}\)</span> means every element of <span class="math inline">\(x\)</span> except for <span class="math inline">\(x_i\)</span>, <span class="math inline">\(S_i\)</span> is the set of neighbors of <span class="math inline">\(x_i\)</span>, and <span class="math inline">\(w_{ij}\)</span> are weights.</p>
<p>This can be written as a multivariate normal variate with mean 0 and a precision matrix, <span class="math inline">\(\mathbf Q\)</span>, which is defined as</p>
<p><span class="math display">\[
Q = D(I - \alpha A).
\]</span></p>
<p>Here, D is a diagonal matrix with <span class="math inline">\(D_{ii} = d_i\)</span> being equal to the number of neighbors of <span class="math inline">\(x_i\)</span>, <span class="math inline">\(A\)</span> is the adjacency matrix</p>
<p><span class="math display">\[
A_{ij} = 1 \iff x_j \in S_i,
\]</span></p>
<p><span class="math inline">\(I\)</span> is the identity matrix, and <span class="math inline">\(0 &lt; \alpha &lt; 1\)</span> is a parameter that encodes the amount of spatial dependence. If <span class="math inline">\(\alpha = 0\)</span> then there is no spatial dependence and if <span class="math inline">\(\alpha = 1\)</span> we get what is called an ICAR model.</p>
</section>
<section id="intrinsic-conditional-autoregression-icar-models" class="level3">
<h3 class="anchored" data-anchor-id="intrinsic-conditional-autoregression-icar-models">Intrinsic Conditional Autoregression (ICAR) Models</h3>
<p>In an ICAR model the spatial dependence parameter <span class="math inline">\(\alpha = 1\)</span> and so, the precision matrix, <span class="math inline">\(Q\)</span>, is singular since then</p>
<p><span class="math display">\[
Q = D(I - A).
\]</span></p>
<p>Recall that <span class="math inline">\(D_{ii} = d_i\)</span> is equal to the number of neighbors of <span class="math inline">\(x_i\)</span> and so the diagonal of <span class="math inline">\(Q\)</span> will be equal to the sum of its off-diagonal elements. This can still be used as a prior, but we must take care since it is an improper prior.</p>
<p>The conditional distribution of <span class="math inline">\(x_i\)</span> given all other observations is</p>
<p><span class="math display">\[
x_i \vert x_{-i} \sim \mathrm{Normal}\left( \frac{ \sum_{j\in S_i}{x_j}}{d_i}, \frac{\sigma_i^2}{d_i}\right).
\]</span></p>
<p>If we specify that <span class="math inline">\(x\)</span> as mean 0 and variance 1, then the joint distribution of <span class="math inline">\(x\)</span> becomes</p>
<p><span class="math display">\[
x \sim \exp\left(-\frac12 \sum_{j\in S_i}{(x_i - x_j)^2}\right).
\]</span></p>
<p>We can easily see that this is not proper, since any constant added to all of the <span class="math inline">\(x_i\)</span>’s will give the same density. One way around this issue is to add the constraint <span class="math inline">\(\sum x_i = 0\)</span>.</p>
</section>
<section id="besag-york-mollié-bym-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="besag-york-mollié-bym-model">Besag York Mollié (BYM) Model</h3>
<p>The BYM model is composed of two different types of random effects:</p>
<ul>
<li>An ICAR component <span class="math inline">\(\phi\)</span></li>
<li>An iid non-spatial component <span class="math inline">\(\theta\)</span></li>
</ul>
<p>Here, both <span class="math inline">\(\phi\)</span> and <span class="math inline">\(\theta\)</span> are assumed to follow normal distributions with means 0 and precision parameters <span class="math inline">\(\tau_\phi\)</span> and <span class="math inline">\(\tau_\theta\)</span>. We can see that if <span class="math inline">\(\tau_\phi\)</span> is estimated to be much higher than <span class="math inline">\(\tau_\theta\)</span> then our data is implying more spatial than non-spatial dependence <em>(and vice versa)</em>.</p>
<p>One difficulty in using this model is that apriori we want <em>“fair”</em> hyperpriors for the precision parameters, i.e.&nbsp;we do not want our prior to weight our model in the direction of more or less spatial dependence. One way to choose these priors is the formula from <span class="citation" data-cites="lBayesianEstimatesDisease1995">(<a href="#ref-lBayesianEstimatesDisease1995" role="doc-biblioref">L, D, and C 1995</a>)</span>:</p>
<div class="no-row-height column-margin column-container"><div id="ref-lBayesianEstimatesDisease1995" class="csl-entry" role="listitem">
L, Bernardinelli, Clayton D, and Montomoli C. 1995. <span>“Bayesian Estimates of Disease Maps: How Important Are Priors?”</span> <em>Statistics in Medicine</em> 14 (21-22). <a href="https://doi.org/10.1002/sim.4780142111">https://doi.org/10.1002/sim.4780142111</a>.
</div></div><p><span class="math display">\[
sd(\theta_i) = \frac{1}{\sqrt{\tau_\phi}} \approx \frac{1}{0.7\sqrt{\bar m \tau_\theta}} \approx sd(\phi_i),
\]</span></p>
<p>where <span class="math inline">\(\bar m\)</span> is the average number of neighbors for each <span class="math inline">\(x_i\)</span>.</p>
</section>
<section id="bym2-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="bym2-model">BYM2 Model</h3>
<p>The BYM2 model <span class="citation" data-cites="rieblerIntuitiveBayesianSpatial2016">(<a href="#ref-rieblerIntuitiveBayesianSpatial2016" role="doc-biblioref">Riebler et al. 2016</a>)</span> rewrites the hyperpriors from the BYM model in a way that follows the <em>Penalized Complexity Priors</em> framework <span class="citation" data-cites="simpsonPenalisingModelComponent2015">(<a href="#ref-simpsonPenalisingModelComponent2015" role="doc-biblioref">Simpson et al. 2015</a>)</span>. The prior is rewritten so that a single scale parameter, <span class="math inline">\(\sigma\)</span>, determines the variance of both components, and a mixing parameter, <span class="math inline">\(\rho\)</span>, determines the amount of spatial/non-spatial random effect.</p>
<div class="no-row-height column-margin column-container"><div id="ref-rieblerIntuitiveBayesianSpatial2016" class="csl-entry" role="listitem">
Riebler, Andrea, Sigrunn H. Sørbye, Daniel Simpson, and Håvard Rue. 2016. <span>“An Intuitive <span>Bayesian</span> Spatial Model for Disease Mapping That Accounts for Scaling.”</span> August 2016. <a href="https://journals.sagepub.com/doi/full/10.1177/0962280216660421">https://journals.sagepub.com/doi/full/10.1177/0962280216660421</a>.
</div><div id="ref-simpsonPenalisingModelComponent2015" class="csl-entry" role="listitem">
Simpson, Daniel P., Håvard Rue, Thiago G. Martins, Andrea Riebler, and Sigrunn H. Sørbye. 2015. <span>“Penalising Model Component Complexity: <span>A</span> Principled, Practical Approach to Constructing Priors.”</span> August 6, 2015. <a href="http://arxiv.org/abs/1403.4630">http://arxiv.org/abs/1403.4630</a>.
</div></div><p>The combined effects, <span class="math inline">\(\phi + \theta\)</span>, are thus rewritten as</p>
<p><span class="math display">\[
\sigma \cdot \left( \sqrt{\rho} \cdot \frac{\phi^*}{\sqrt s} + \sqrt{1 - \rho} \cdot\theta^* \right),
\]</span> where <span class="math inline">\(0 \leq \rho \leq 1\)</span> determines the amount of spatial/non-spatial error, <span class="math inline">\(\phi^*\)</span> is the ICAR model, <span class="math inline">\(\theta^*\)</span> is an iid random effect, <span class="math inline">\(s\)</span> is the scaling factor for the neighborhood graph, <span class="math inline">\(\sigma \geq 0\)</span> is the overall standard deviation of the combined random effects.</p>
</section>
</section>
<section id="copulas" class="level2">
<h2 class="anchored" data-anchor-id="copulas">Copulas</h2>
<p>Even if we use the aforementioned models to allow spatial dependence between the paremeters in our GEV distributions, there is still one problem: We’re not modeling spatial distributions on the data level.</p>
<p>This means that our model as it is currently set up can allow spatial dependence in how often extreme precipitation happens in neighboring regions, but it does not allow for spatial dependence in when we observe extreme precipitation. To do this, we will need to apply copulas. I will not write about them here, but I have a post on the way about applying copulas to data with GEV margins.</p>
</section>
</section>
<section id="data" class="level1 page-columns page-full">
<h1>Data</h1>
<p>The data used in this research are downloaded from the CEDA Archive:</p>
<ul>
<li><a href="https://data.ceda.ac.uk/badc/ukcp18/data/land-cpm/uk/5km">UKCP Local Projections on a 5km grid over the UK for 1980-2080</a></li>
</ul>
<p>The raw data contain climate projections for the UK on a 5km grid from 1980 to 2080 for a high emissions scenario, <em>RCP8.5</em>, and contain hourly precipitation rates of <span class="math inline">\(43.920\)</span> squares on a <span class="math inline">\(180 \times 244\)</span> grid. The projections are calculated for <span class="math inline">\(1980 - 2000\)</span>, <span class="math inline">\(2020 - 2040\)</span>, and <span class="math inline">\(2060 - 2080\)</span>, thus giving <span class="math inline">\(60 \times 365 \times 24 \times 180 \times 244 \approx 2.3 \cdot 10^{10}\)</span> data points.</p>
<p>The raw data were processed by calculating the yearly maximum over the hourly precipitation rates for each station, thus reducing the number of data points to <span class="math inline">\(60 \times 180 \times 244 \approx 2.6 \cdot 10^6\)</span>.</p>
<p>For a description of how to download the data, see my post on <a href="https://bggj.is/posts/ceda-archive/">Fetching FTP data from the Ceda Archives</a>.</p>
<section id="subset-of-the-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="subset-of-the-data">Subset of the data</h2>
<p>For this analysis, I will be subsetting the data to save time. I’m going to use 10.201 stations with X projections between 50 and 150, and Y projections between 100 and 200.</p>
<section id="stations" class="level3">
<h3 class="anchored" data-anchor-id="stations">Stations</h3>
<p>To be able to index the stations in my Stan program, I give the stations new names according to their row number. In the filtered dataset.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model_stations <span class="ot">&lt;-</span> stations <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(proj_x, <span class="dv">50</span>, <span class="dv">150</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(proj_y, <span class="dv">100</span>, <span class="dv">200</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> model_stations <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_name =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(station, new_name)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>model_stations <span class="sc">|&gt;</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skim</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="precipitation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="precipitation">Precipitation</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model_precip <span class="ot">&lt;-</span> precip <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    model_stations,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(station)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>model_precip <span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skim</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> model_precip <span class="sc">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    station <span class="sc">%in%</span> <span class="fu">sample</span>(station, <span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">period =</span> <span class="dv">1</span> <span class="sc">+</span> (year <span class="sc">&gt;=</span> <span class="dv">2020</span>) <span class="sc">+</span> (year <span class="sc">&gt;=</span> <span class="dv">2060</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">period =</span> <span class="fu">c</span>(<span class="st">"1980 - 2000"</span>, <span class="st">"2020 - 2040"</span>, <span class="st">"2060 - 2080"</span>)[period],</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">station =</span> <span class="fu">str_c</span>(<span class="st">"Station</span><span class="sc">\n</span><span class="st">"</span>, station)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(year, precip)) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> <span class="dv">0</span>, <span class="at">xend =</span> year</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">lty =</span> <span class="dv">2</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">0.6</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">vars</span>(period),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">rows =</span> <span class="fu">vars</span>(station),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free_x"</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"An example of extreme value observations"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Annual values of maximum daily precipitation for a sample of stations in the data"</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot =</span> p,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"Figures/ts_extreme_plot.png"</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="fl">0.621</span> <span class="sc">*</span> <span class="dv">8</span>, <span class="at">scale =</span> <span class="fl">1.3</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p class="page-columns page-full"><img src="Figures/ts_extreme_plot.png" class="column-page img-fluid"></p>
</section>
</section>
<section id="prepare-the-data-for-stan" class="level2">
<h2 class="anchored" data-anchor-id="prepare-the-data-for-stan">Prepare the data for Stan</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>precip_matrix <span class="ot">&lt;-</span> model_precip <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> station, <span class="at">values_from =</span> precip) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"year"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>N_stations <span class="ot">&lt;-</span> <span class="fu">ncol</span>(precip_matrix)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>N_years <span class="ot">&lt;-</span> <span class="fu">nrow</span>(precip_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> twelve_neighbors <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"e"</span>, <span class="st">"n"</span>, <span class="st">"w"</span>, <span class="st">"s"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    model_stations,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(station)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    model_stations,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(neighbor <span class="sc">==</span> station)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station, neighbor) <span class="sc">|&gt;</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_names</span>(station) <span class="sc">|&gt;</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_names</span>(neighbor)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>N_neighbors <span class="ot">=</span> <span class="fu">nrow</span>(edges)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">&lt;-</span> edges<span class="sc">$</span>station</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">&lt;-</span> edges<span class="sc">$</span>neighbor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nbs <span class="ot">&lt;-</span> edges <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(neighbor <span class="sc">&gt;</span> station) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">node1 =</span> station, <span class="at">node2 =</span> neighbor)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(model_stations)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>adj.matrix <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(<span class="at">i =</span> nbs<span class="sc">$</span>node1, <span class="at">j =</span> nbs<span class="sc">$</span>node2, <span class="at">x =</span> <span class="dv">1</span>, <span class="at">symmetric =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The ICAR precision matrix (note! This is singular)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(N, <span class="fu">rowSums</span>(adj.matrix)) <span class="sc">-</span> adj.matrix</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a small jitter to the diagonal for numerical stability (optional but recommended)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>Q_pert <span class="ot">&lt;-</span> Q <span class="sc">+</span> <span class="fu">Diagonal</span>(N) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">diag</span>(Q)) <span class="sc">*</span> <span class="fu">sqrt</span>(.Machine<span class="sc">$</span>double.eps)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the diagonal elements of the covariance matrix subject to the</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># constraint that the entries of the ICAR sum to zero.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># See the inla.qinv function help for further details.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>Q_inv <span class="ot">&lt;-</span> <span class="fu">inla.qinv</span>(Q_pert, <span class="at">constr =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">1</span>, N), <span class="at">e =</span> <span class="dv">0</span>))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the geometric mean of the variances, which are on the diagonal of Q.inv</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>scaling_factor <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">mean</span>(<span class="fu">log</span>(<span class="fu">diag</span>(Q_inv))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_stations =</span> N_stations,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_years =</span> N_years,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">precip =</span> precip_matrix,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_neighbors =</span> N_neighbors,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">node1 =</span> node1,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">node2 =</span> node2,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">scaling_factor =</span> scaling_factor</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="model" class="level1 page-columns page-full">
<h1>Model</h1>
<p>The model is written below in mathematical notation and Stan code.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset page-columns page-full">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Math</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Stan</a></li></ul>
<div class="tab-content page-columns page-full">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p><span class="math display">\[
\begin{gathered}
y_{it} \sim \mathrm{GEV}(\mu_{it}, \sigma_i, \xi_i) \\
\mu_{it} = \mu_i^0 \cdot(1 + \Delta_i (t - t_0)) \\
\begin{pmatrix}
\psi_i \\ \tau_i \\ \phi_i \\ \gamma_i
\end{pmatrix} =
\begin{pmatrix}
\log(\mu_{i}^0) \\
\log(\sigma_i) - \psi_i \\
f_\phi(\xi) \\
f_\gamma(\Delta)
\end{pmatrix} \\
\psi \sim \mathrm{Normal}(\mu_\psi, \Sigma_\psi^*) \quad
\Sigma_\psi^* \sim \mathrm{BYM2}_\psi(\sigma_\psi, \rho_\psi) \\
\tau \sim \mathrm{Normal}(\mu_\tau, \Sigma^*_\tau) \quad
\Sigma^*_\tau \sim \mathrm{BYM2}_\tau(\sigma_\tau, \rho_\tau) \\
\phi \sim \mathrm{Normal}(\mu_\phi, \Sigma^*_\phi) \quad
\Sigma^*_\phi \sim \mathrm{BYM2}_\phi(\sigma_\phi, \rho_\phi) \\
\gamma \sim \mathrm{Normal}(\mu_\gamma, \Sigma^*_\gamma) \quad
\Sigma^*_\gamma \sim \mathrm{BYM2}_\gamma(\sigma_\gamma, \rho_\gamma) \\
\sigma_\psi, \sigma_\tau, \sigma_\phi, \sigma_\gamma \sim \mathrm{Exponential}(1) \\
\mathrm{logit}(\rho_\phi), \dots, \mathrm{logit(\rho_\gamma)} \sim \mathrm{Normal}(0, 1)
\end{gathered}
\]</span></p>
</div>
<div id="tabset-1-2" class="tab-pane page-columns page-full" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell column-screen-right" data-output.var="modell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span>{</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">Fit a GEV distribution with trend</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> gevt_lpdf(<span class="dt">vector</span> y, <span class="dt">real</span> mu0, <span class="dt">real</span> sigma, <span class="dt">real</span> xi, <span class="dt">real</span> delta) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> N = rows(y);</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] z;</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] mu;</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> lp = <span class="dv">0</span>;</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>mu[i] = mu0 * (<span class="dv">1</span> + delta * (i - <span class="dv">1</span>));</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (z[i] &lt;= -<span class="dv">1</span>) {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="kw">reject</span>(<span class="st">"found incompatible variable values"</span>);</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (abs(xi) &lt; <span class="fl">1e-12</span>) {</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>z[i] = (y[i] - mu[i]) / sigma;</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>lp += - z[i] - exp(-z[i]);</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>z[i] = xi * (y[i] - mu[i]) / sigma;</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>lp += - (<span class="dv">1</span> + <span class="dv">1</span> / xi) * log(<span class="dv">1</span> + z[i]) - pow((<span class="dv">1</span> + z[i]), -<span class="dv">1</span>/xi);</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>lp += -N * log(sigma);</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> lp;</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">Put an ICAR prior on coefficients</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> icar_normal_lpdf(<span class="dt">vector</span> phi, <span class="dt">int</span> N, <span class="dt">array</span>[] <span class="dt">int</span> node1, <span class="dt">array</span>[] <span class="dt">int</span> node2) {</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> - <span class="fl">0.5</span> * dot_self((phi[node1] - phi[node2])) </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>+ normal_lpdf(sum(phi) | <span class="dv">0</span>, <span class="fl">0.001</span> * N);</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; N_years;</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; N_stations;</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="dt">matrix</span>[N_years, N_stations] precip;</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; N_neighbors;</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[N_neighbors] <span class="dt">int</span> node1;</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[N_neighbors] <span class="dt">int</span> node2;</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; scaling_factor;</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] psi_random;</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] psi_spatial;</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma_psi;</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> mu_psi;</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> logit_rho_psi;</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] tau_random;</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] tau_spatial;</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma_tau;</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> mu_tau;</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> logit_rho_tau;</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] phi_random;</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] phi_spatial;</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma_phi;</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> mu_phi;</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> logit_rho_phi;</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] gamma_random;</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] gamma_spatial;</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> mu_gamma;</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> logit_rho_gamma;</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; rho_psi = inv_logit(logit_rho_psi);</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; rho_tau = inv_logit(logit_rho_tau);</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; rho_phi = inv_logit(logit_rho_phi);</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; rho_gamma = inv_logit(logit_rho_gamma);</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] psi = mu_psi + sigma_psi * (sqrt(rho_psi / scaling_factor) * psi_spatial + sqrt(<span class="dv">1</span> - rho_psi) * psi_random);</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] tau = mu_tau + sigma_tau * (sqrt(rho_tau / scaling_factor) * tau_spatial + sqrt(<span class="dv">1</span> - rho_tau) * tau_random);</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] phi = mu_phi + sigma_phi * (sqrt(rho_phi / scaling_factor) * phi_spatial + sqrt(<span class="dv">1</span> - rho_phi) * phi_random);</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N_stations] gamma = mu_gamma + sigma_gamma * (sqrt(rho_gamma / scaling_factor) * gamma_spatial + sqrt(<span class="dv">1</span> - rho_gamma) * gamma_random);</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[N_stations] mu0 = exp(psi);</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[N_stations] sigma = exp(psi + tau);</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span> = -<span class="fl">0.5</span>, <span class="kw">upper</span> = <span class="fl">0.5</span>&gt;[N_stations] xi = inv_logit(phi) - <span class="fl">0.5</span>;</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>&lt;<span class="kw">lower</span> = -<span class="fl">0.01</span>, <span class="kw">upper</span> = <span class="fl">0.01</span>&gt;[N_stations] delta = <span class="fl">0.02</span> * inv_logit(gamma) - <span class="fl">0.01</span>;</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N_stations) {</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>precip[ , i] ~ gevt(mu0[i], sigma[i], xi[i], delta[i]);</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>psi_spatial ~ icar_normal(N_neighbors, node1, node2);</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>psi_random ~ std_normal();</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>sigma_psi ~ exponential(<span class="dv">1</span>);</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>logit_rho_psi ~ std_normal();</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>mu_psi ~ normal(<span class="fl">2.2</span>, <span class="dv">1</span>);</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>tau_spatial ~ icar_normal(N_neighbors, node1, node2);</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>tau_random ~ std_normal();</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>sigma_tau ~ exponential(<span class="dv">1</span>);</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>logit_rho_tau ~ std_normal();</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>mu_tau ~ normal(-<span class="fl">0.9</span>, <span class="dv">1</span>);</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>phi_spatial ~ icar_normal(N_neighbors, node1, node2);</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>phi_random ~ std_normal();</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>sigma_phi ~ exponential(<span class="dv">1</span>);</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>logit_rho_phi ~ std_normal();</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>mu_phi ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>gamma_spatial ~ icar_normal(N_neighbors, node1, node2);</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>gamma_random ~ std_normal();</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>sigma_gamma ~ exponential(<span class="dv">1</span>);</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>logit_rho_gamma ~ std_normal();</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>mu_gamma ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">here</span>(<span class="st">"posts"</span>, <span class="st">"icar_gev"</span>, <span class="st">"Stan"</span>, <span class="st">"BYM_GEV_LOGIT.stan"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_warmup =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">10</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="fu">here</span>(<span class="st">"posts"</span>, <span class="st">"icar_gev"</span>, <span class="st">"Stan"</span>, <span class="st">"Draws"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results" class="level1 page-columns page-full">
<h1>Results</h1>
<p>I won’t show convergence analytics here, but after doing our due diligence we can move on to looking at parameter estimates.</p>
<section id="bym2-parameters" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="bym2-parameters">BYM2 Parameters</h2>
<div class="cell page-columns page-full">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">here</span>(<span class="st">"posts"</span>, <span class="st">"icar_gev"</span>, <span class="st">"results"</span>, <span class="st">"bym_results.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">str_c</span>(<span class="st">"&lt;b&gt;&amp;"</span>, variable, <span class="st">";&lt;/sub&gt;&lt;/b&gt;"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_replace</span>(<span class="st">"_"</span>, <span class="st">";&lt;sub&gt;&amp;"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Our BYM2 hyperparameters point to a large degree of spatial variation"</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_markdown</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> variable</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> mean<span class="sc">:</span>rhat,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">3</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> ess_bulk<span class="sc">:</span>ess_tail,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">0</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(<span class="at">table.width =</span> <span class="fu">pct</span>(<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display column-screen-inset-right">
<div>
<div id="snqomnejqc" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#snqomnejqc table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#snqomnejqc thead, #snqomnejqc tbody, #snqomnejqc tfoot, #snqomnejqc tr, #snqomnejqc td, #snqomnejqc th {
  border-style: none;
}

#snqomnejqc p {
  margin: 0;
  padding: 0;
}

#snqomnejqc .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: 100%;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#snqomnejqc .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#snqomnejqc .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#snqomnejqc .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#snqomnejqc .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snqomnejqc .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snqomnejqc .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#snqomnejqc .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#snqomnejqc .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#snqomnejqc .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#snqomnejqc .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#snqomnejqc .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#snqomnejqc .gt_spanner_row {
  border-bottom-style: hidden;
}

#snqomnejqc .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#snqomnejqc .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#snqomnejqc .gt_from_md > :first-child {
  margin-top: 0;
}

#snqomnejqc .gt_from_md > :last-child {
  margin-bottom: 0;
}

#snqomnejqc .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#snqomnejqc .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#snqomnejqc .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#snqomnejqc .gt_row_group_first td {
  border-top-width: 2px;
}

#snqomnejqc .gt_row_group_first th {
  border-top-width: 2px;
}

#snqomnejqc .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#snqomnejqc .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#snqomnejqc .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#snqomnejqc .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snqomnejqc .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#snqomnejqc .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#snqomnejqc .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#snqomnejqc .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#snqomnejqc .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#snqomnejqc .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snqomnejqc .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#snqomnejqc .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#snqomnejqc .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#snqomnejqc .gt_left {
  text-align: left;
}

#snqomnejqc .gt_center {
  text-align: center;
}

#snqomnejqc .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#snqomnejqc .gt_font_normal {
  font-weight: normal;
}

#snqomnejqc .gt_font_bold {
  font-weight: bold;
}

#snqomnejqc .gt_font_italic {
  font-style: italic;
}

#snqomnejqc .gt_super {
  font-size: 65%;
}

#snqomnejqc .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#snqomnejqc .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#snqomnejqc .gt_indent_1 {
  text-indent: 5px;
}

#snqomnejqc .gt_indent_2 {
  text-indent: 10px;
}

#snqomnejqc .gt_indent_3 {
  text-indent: 15px;
}

#snqomnejqc .gt_indent_4 {
  text-indent: 20px;
}

#snqomnejqc .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header gt_heading">
<th colspan="10" class="gt_heading gt_title gt_font_normal gt_bottom_border">Our BYM2 hyperparameters point to a large degree of spatial variation</th>
</tr>
<tr class="odd gt_col_headings">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>σ<sub>ψ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.072</td>
<td class="gt_row gt_right" headers="median">0.072</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">0.070</td>
<td class="gt_row gt_right" headers="q95">0.074</td>
<td class="gt_row gt_right" headers="rhat">1.012</td>
<td class="gt_row gt_right" headers="ess_bulk">137</td>
<td class="gt_row gt_right" headers="ess_tail">387</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>μ<sub>ψ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">2.133</td>
<td class="gt_row gt_right" headers="median">2.133</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">2.131</td>
<td class="gt_row gt_right" headers="q95">2.135</td>
<td class="gt_row gt_right" headers="rhat">1.001</td>
<td class="gt_row gt_right" headers="ess_bulk">5,029</td>
<td class="gt_row gt_right" headers="ess_tail">3,417</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>ρ<sub>ψ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.998</td>
<td class="gt_row gt_right" headers="median">0.998</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">0.997</td>
<td class="gt_row gt_right" headers="q95">0.999</td>
<td class="gt_row gt_right" headers="rhat">1.000</td>
<td class="gt_row gt_right" headers="ess_bulk">3,161</td>
<td class="gt_row gt_right" headers="ess_tail">3,218</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>σ<sub>τ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.102</td>
<td class="gt_row gt_right" headers="median">0.102</td>
<td class="gt_row gt_right" headers="sd">0.002</td>
<td class="gt_row gt_right" headers="mad">0.002</td>
<td class="gt_row gt_right" headers="q5">0.098</td>
<td class="gt_row gt_right" headers="q95">0.106</td>
<td class="gt_row gt_right" headers="rhat">1.015</td>
<td class="gt_row gt_right" headers="ess_bulk">381</td>
<td class="gt_row gt_right" headers="ess_tail">973</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>μ<sub>τ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">−0.923</td>
<td class="gt_row gt_right" headers="median">−0.923</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">−0.926</td>
<td class="gt_row gt_right" headers="q95">−0.921</td>
<td class="gt_row gt_right" headers="rhat">1.000</td>
<td class="gt_row gt_right" headers="ess_bulk">4,130</td>
<td class="gt_row gt_right" headers="ess_tail">3,507</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>ρ<sub>τ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.997</td>
<td class="gt_row gt_right" headers="median">0.998</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">0.996</td>
<td class="gt_row gt_right" headers="q95">0.999</td>
<td class="gt_row gt_right" headers="rhat">1.001</td>
<td class="gt_row gt_right" headers="ess_bulk">3,192</td>
<td class="gt_row gt_right" headers="ess_tail">2,903</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>σ<sub>φ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.358</td>
<td class="gt_row gt_right" headers="median">0.358</td>
<td class="gt_row gt_right" headers="sd">0.009</td>
<td class="gt_row gt_right" headers="mad">0.009</td>
<td class="gt_row gt_right" headers="q5">0.343</td>
<td class="gt_row gt_right" headers="q95">0.372</td>
<td class="gt_row gt_right" headers="rhat">1.008</td>
<td class="gt_row gt_right" headers="ess_bulk">401</td>
<td class="gt_row gt_right" headers="ess_tail">730</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>μ<sub>φ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.341</td>
<td class="gt_row gt_right" headers="median">0.341</td>
<td class="gt_row gt_right" headers="sd">0.004</td>
<td class="gt_row gt_right" headers="mad">0.004</td>
<td class="gt_row gt_right" headers="q5">0.335</td>
<td class="gt_row gt_right" headers="q95">0.347</td>
<td class="gt_row gt_right" headers="rhat">1.001</td>
<td class="gt_row gt_right" headers="ess_bulk">3,728</td>
<td class="gt_row gt_right" headers="ess_tail">3,049</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>ρ<sub>φ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.996</td>
<td class="gt_row gt_right" headers="median">0.997</td>
<td class="gt_row gt_right" headers="sd">0.001</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">0.994</td>
<td class="gt_row gt_right" headers="q95">0.998</td>
<td class="gt_row gt_right" headers="rhat">1.002</td>
<td class="gt_row gt_right" headers="ess_bulk">1,995</td>
<td class="gt_row gt_right" headers="ess_tail">2,677</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>σ<sub>γ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.332</td>
<td class="gt_row gt_right" headers="median">0.333</td>
<td class="gt_row gt_right" headers="sd">0.011</td>
<td class="gt_row gt_right" headers="mad">0.011</td>
<td class="gt_row gt_right" headers="q5">0.313</td>
<td class="gt_row gt_right" headers="q95">0.351</td>
<td class="gt_row gt_right" headers="rhat">1.029</td>
<td class="gt_row gt_right" headers="ess_bulk">105</td>
<td class="gt_row gt_right" headers="ess_tail">208</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable"><p><b>μ<sub>γ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">1.438</td>
<td class="gt_row gt_right" headers="median">1.438</td>
<td class="gt_row gt_right" headers="sd">0.012</td>
<td class="gt_row gt_right" headers="mad">0.012</td>
<td class="gt_row gt_right" headers="q5">1.419</td>
<td class="gt_row gt_right" headers="q95">1.458</td>
<td class="gt_row gt_right" headers="rhat">1.001</td>
<td class="gt_row gt_right" headers="ess_bulk">2,517</td>
<td class="gt_row gt_right" headers="ess_tail">3,053</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable"><p><b>ρ<sub>γ</sub></b></p></td>
<td class="gt_row gt_right" headers="mean">0.996</td>
<td class="gt_row gt_right" headers="median">0.996</td>
<td class="gt_row gt_right" headers="sd">0.002</td>
<td class="gt_row gt_right" headers="mad">0.001</td>
<td class="gt_row gt_right" headers="q5">0.993</td>
<td class="gt_row gt_right" headers="q95">0.998</td>
<td class="gt_row gt_right" headers="rhat">1.000</td>
<td class="gt_row gt_right" headers="ess_bulk">3,823</td>
<td class="gt_row gt_right" headers="ess_tail">2,875</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="spatial-distribution" class="level2">
<h2 class="anchored" data-anchor-id="spatial-distribution">Spatial Distribution</h2>
<section id="unconstrained-scale" class="level3">
<h3 class="anchored" data-anchor-id="unconstrained-scale">Unconstrained Scale</h3>
<p><img src="Figures/facet_unconstrained.png" class="img-fluid"></p>
</section>
<section id="constrained-scale" class="level3">
<h3 class="anchored" data-anchor-id="constrained-scale">Constrained Scale</h3>
<p><img src="Figures/facet_constrained.png" class="img-fluid"></p>



</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.bggj\.is");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>