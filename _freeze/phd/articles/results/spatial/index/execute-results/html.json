{
  "hash": "5dd25b6ab36426783946f6be9697a484",
  "result": {
    "markdown": "---\ntitle: \"The Smooth Step\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bggjphd)\nlibrary(tidyverse)\nlibrary(bayesplot)\nlibrary(GGally)\nlibrary(scales)\nlibrary(cowplot)\nlibrary(kableExtra)\nlibrary(arrow)\ntheme_set(theme_bggj())\n```\n:::\n\n\nThe latent parameters, $\\psi$, $\\tau$, $\\phi$, and $\\gamma$, are given intrinsic random walk spatial priors, for example\n\n$$\n\\begin{aligned}\n\\psi &\\sim \\mathcal N(\\mathbf 0, \\tau_\\psi \\cdot Q_u) \\\\\n\\sigma_\\psi &= \\frac{1}{\\sqrt\\tau_\\psi} \\\\\n\\sigma_\\psi &\\sim \\mathrm{Exp}(1)\n\\end{aligned}\n$$\n\nHere, $Q_u$ is defined by\n\n$$\nQ_u = R \\otimes I + I \\otimes R,\n$$\n\nwhere $I$ is the identity matrix and\n\n$$\nR = \\begin{bmatrix}\n1 & -1 & & & & & \\\\\n-1 & 2 & -1 & & & & \\\\\n& -1 & 2 & -1 & & & \\\\\n& & \\ddots & \\ddots & \\ddots & & \\\\\n& & &-1 &2 &-1 & \\\\\n& & & & -1 & 1\\\\\n\\end{bmatrix}.\n$$\n\nThe results were obtained by running `ms_smooth()` in parrallel on four cores with four chains each run for 4000 samples. Half of those samples were designated as warm-up and so we have a total of 8000 samples from the posterior.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results <- read_parquet(\"data/theta_results.parquet\") |> \n  as_draws_df()\n\nstation_results <- read_parquet(\"data/station_results.parquet\")\n\nn_iter <- theta_results |> \n  as_tibble() |> \n  pull(.iteration) |> \n  max()\n```\n:::\n\n\n\n\n# MCMC Diagnostics\n\n## Trace plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |>\n  mcmc_trace()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n## Autocorrelation functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |> \n  mcmc_acf_bar()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## Acceptance probability\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results |> \n  subset_draws(\"theta[1]\") |> \n  as_tibble() |> \n  rename(value = \"theta[1]\") |> \n  group_by(.chain) |> \n  mutate(accept = 1 * (value != lag(value))) |> \n  ungroup() |> \n  ggplot(aes(.iteration, accept, group = .chain)) +\n  geom_smooth(method = \"loess\", span = 0.3, se = 0) +\n  scale_x_continuous(\n    expand = expansion()\n  ) +\n  scale_y_continuous(\n    breaks = pretty_breaks(5),\n    labels = label_percent(),\n    expand = expansion()\n  ) +\n  theme(\n    plot.margin = margin(t = 5, r = 35, b = 5, l = 5)\n  ) +  \n  coord_cartesian(ylim = c(0, 1)) +\n  labs(\n    x = \"Iteration\",\n    y = \"Acceptance probability\",\n    title = \"Acceptance probability for theta[1]\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n# Parameters\n\n## Hyperpriors\n\n### Log precision scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |> \n  summarise_draws() |> \n  kable(digits = 3) |> \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> variable </th>\n   <th style=\"text-align:right;\"> mean </th>\n   <th style=\"text-align:right;\"> median </th>\n   <th style=\"text-align:right;\"> sd </th>\n   <th style=\"text-align:right;\"> mad </th>\n   <th style=\"text-align:right;\"> q5 </th>\n   <th style=\"text-align:right;\"> q95 </th>\n   <th style=\"text-align:right;\"> rhat </th>\n   <th style=\"text-align:right;\"> ess_bulk </th>\n   <th style=\"text-align:right;\"> ess_tail </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> theta[1] </td>\n   <td style=\"text-align:right;\"> 6.197 </td>\n   <td style=\"text-align:right;\"> 6.197 </td>\n   <td style=\"text-align:right;\"> 0.018 </td>\n   <td style=\"text-align:right;\"> 0.017 </td>\n   <td style=\"text-align:right;\"> 6.169 </td>\n   <td style=\"text-align:right;\"> 6.228 </td>\n   <td style=\"text-align:right;\"> 1.057 </td>\n   <td style=\"text-align:right;\"> 74.104 </td>\n   <td style=\"text-align:right;\"> 175.051 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[2] </td>\n   <td style=\"text-align:right;\"> 5.227 </td>\n   <td style=\"text-align:right;\"> 5.228 </td>\n   <td style=\"text-align:right;\"> 0.021 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 5.192 </td>\n   <td style=\"text-align:right;\"> 5.261 </td>\n   <td style=\"text-align:right;\"> 1.025 </td>\n   <td style=\"text-align:right;\"> 108.293 </td>\n   <td style=\"text-align:right;\"> 268.148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[3] </td>\n   <td style=\"text-align:right;\"> 3.559 </td>\n   <td style=\"text-align:right;\"> 3.559 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 3.523 </td>\n   <td style=\"text-align:right;\"> 3.597 </td>\n   <td style=\"text-align:right;\"> 1.021 </td>\n   <td style=\"text-align:right;\"> 145.799 </td>\n   <td style=\"text-align:right;\"> 225.786 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[4] </td>\n   <td style=\"text-align:right;\"> 4.947 </td>\n   <td style=\"text-align:right;\"> 4.948 </td>\n   <td style=\"text-align:right;\"> 0.034 </td>\n   <td style=\"text-align:right;\"> 0.035 </td>\n   <td style=\"text-align:right;\"> 4.891 </td>\n   <td style=\"text-align:right;\"> 5.001 </td>\n   <td style=\"text-align:right;\"> 1.015 </td>\n   <td style=\"text-align:right;\"> 116.061 </td>\n   <td style=\"text-align:right;\"> 249.864 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell fig.asp='0.8'}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |> \n  mcmc_hist_by_chain(\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### On standard deviation scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |> \n  summarise_draws() |> \n  kable(digits = 3) |> \n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> variable </th>\n   <th style=\"text-align:right;\"> mean </th>\n   <th style=\"text-align:right;\"> median </th>\n   <th style=\"text-align:right;\"> sd </th>\n   <th style=\"text-align:right;\"> mad </th>\n   <th style=\"text-align:right;\"> q5 </th>\n   <th style=\"text-align:right;\"> q95 </th>\n   <th style=\"text-align:right;\"> rhat </th>\n   <th style=\"text-align:right;\"> ess_bulk </th>\n   <th style=\"text-align:right;\"> ess_tail </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> theta[1] </td>\n   <td style=\"text-align:right;\"> 6.197 </td>\n   <td style=\"text-align:right;\"> 6.197 </td>\n   <td style=\"text-align:right;\"> 0.018 </td>\n   <td style=\"text-align:right;\"> 0.017 </td>\n   <td style=\"text-align:right;\"> 6.169 </td>\n   <td style=\"text-align:right;\"> 6.228 </td>\n   <td style=\"text-align:right;\"> 1.057 </td>\n   <td style=\"text-align:right;\"> 74.104 </td>\n   <td style=\"text-align:right;\"> 175.051 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[2] </td>\n   <td style=\"text-align:right;\"> 5.227 </td>\n   <td style=\"text-align:right;\"> 5.228 </td>\n   <td style=\"text-align:right;\"> 0.021 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 5.192 </td>\n   <td style=\"text-align:right;\"> 5.261 </td>\n   <td style=\"text-align:right;\"> 1.025 </td>\n   <td style=\"text-align:right;\"> 108.293 </td>\n   <td style=\"text-align:right;\"> 268.148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[3] </td>\n   <td style=\"text-align:right;\"> 3.559 </td>\n   <td style=\"text-align:right;\"> 3.559 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 0.022 </td>\n   <td style=\"text-align:right;\"> 3.523 </td>\n   <td style=\"text-align:right;\"> 3.597 </td>\n   <td style=\"text-align:right;\"> 1.021 </td>\n   <td style=\"text-align:right;\"> 145.799 </td>\n   <td style=\"text-align:right;\"> 225.786 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> theta[4] </td>\n   <td style=\"text-align:right;\"> 4.947 </td>\n   <td style=\"text-align:right;\"> 4.948 </td>\n   <td style=\"text-align:right;\"> 0.034 </td>\n   <td style=\"text-align:right;\"> 0.035 </td>\n   <td style=\"text-align:right;\"> 4.891 </td>\n   <td style=\"text-align:right;\"> 5.001 </td>\n   <td style=\"text-align:right;\"> 1.015 </td>\n   <td style=\"text-align:right;\"> 116.061 </td>\n   <td style=\"text-align:right;\"> 249.864 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell fig.asp='0.8'}\n\n```{.r .cell-code}\ntheta_results |> \n  filter(.iteration > 2000) |> \n  mcmc_hist_by_chain(\n    transformations = function(x) exp(-x/2)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n## GEV Parameters\n\n### Comparing ML and MCMC estimates\n\n\n\n::: {.cell fig.asp='1'}\n\n```{.r .cell-code}\nstation_results |> \n  pivot_longer(c(ml_estimate, mcmc_mean)) |> \n  mutate(\n    variable = fct_relevel(\n      factor(variable),\n      \"psi\", \"tau\", \"phi\", \"gamma\"\n    ),\n    name = fct_recode(\n      factor(name),\n      \"Maximum Likelihood\" = \"ml_estimate\",\n      \"Posterior Mean\" = \"mcmc_mean\"\n    )\n  ) |> \n  ggplot(aes(value)) +\n  geom_histogram() +\n  facet_wrap(vars(variable, name), ncol = 2, scales = \"free_x\") +\n  theme(\n    axis.line.y = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank()\n  ) +\n  labs(\n    x = NULL,\n    y = NULL,\n    title = \"Distributions of station parameters from ML and MCMC\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell fig.asp='0.8'}\n\n```{.r .cell-code}\nstation_results |> \n  ggplot(aes(ml_estimate, mcmc_mean)) +\n  geom_abline(intercept = 0, slope = 1, lty = 2) +\n  geom_point(alpha = 0.1) +\n  facet_wrap(\"variable\", scales = \"free\") +\n  labs(\n    x = \"ML Estimate (Max step)\",\n    y = \"Posterior Mean (Smooth step)\",\n    title = \"Comparing estimates from the Max and the Smooth steps\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n### Spatial Distributions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproj_plot <- function(data) {\n  \n  title <- str_c(\n    \"Spatial distribution of estimates for \", unique(data$variable)\n  )\n  \n  plot_dat <- data |> \n    pivot_longer(c(ml_estimate, mcmc_mean)) |> \n    mutate(\n      name = fct_recode(\n        factor(name),\n        \"Maximum Likelihood\" = \"ml_estimate\",\n        \"Posterior Mean\" = \"mcmc_mean\"\n      )\n    ) |> \n    group_by(name) |> \n    mutate(\n      value = (value - mean(value)) / sd(value)\n    ) |> \n    ungroup() |> \n    mutate(\n      value = case_when(\n        name == \"Posterior Mean\" ~ value,\n        value < quantile(value, 0.0025) ~ quantile(value, 0.0025),\n        value > quantile(value, 0.9975) ~ quantile(value, 0.9975),\n        TRUE ~ value\n      )\n    )\n  \n  min_val <- min(plot_dat$value)\n  max_val <- max(plot_dat$value)\n  \n  lim_range <- max(abs(min_val), abs(max_val))\n  \n  limits <- c(-1, 1) * lim_range\n  \n  plot_dat |> \n    ggplot(aes(proj_x, proj_y)) +\n    geom_raster(aes(fill = value)) +\n    scale_fill_viridis_c(limits = limits) +\n    facet_wrap(\"name\", nrow = 1) +\n    coord_cartesian(expand = FALSE) +\n    labs(\n      title = title,\n      fill = NULL,\n      x = \"X projection\",\n      y = \"Y projection\"\n    )\n}\n```\n:::\n\n\n#### Location\n\n##### psi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"psi\") |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n##### mu\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"psi\") |> \n  mutate(variable = \"mu\") |> \n  mutate_at(vars(ml_estimate, mcmc_mean), exp) |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n#### Scale\n\n##### tau\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"tau\") |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n##### sigma\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable %in% c(\"tau\", \"psi\")) |> \n  pivot_longer(c(ml_estimate, mcmc_mean)) |> \n  pivot_wider(names_from = variable, values_from = value) |> \n  mutate(sigma = exp(tau + psi)) |> \n  select(-psi, -tau) |> \n  pivot_longer(c(sigma), names_to = \"variable\", values_to = \"value\") |> \n  pivot_wider() |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n#### Shape\n\n##### phi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"phi\") |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n##### xi\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"phi\") |> \n  mutate(variable = \"xi\") |> \n  mutate_at(vars(ml_estimate, mcmc_mean), link_shape_inverse) |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n#### Trend\n\n##### gamma\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"gamma\") |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n##### Delta\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_results |> \n  filter(variable == \"gamma\") |> \n  mutate(variable = \"delta\") |> \n  mutate_at(vars(ml_estimate, mcmc_mean), link_trend_inverse) |> \n  proj_plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}