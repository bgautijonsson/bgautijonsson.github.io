{
  "hash": "05b32f0b083812dda1c26313ce5e50ed",
  "result": {
    "markdown": "---\ntitle: \"The Max Step\"\nbibliography: references.bib\nreference-location: margin\ncitation-location: margin\n---\n\n\n# The GEV Model\n\n\n```{=tex}\n\\mathrm{GEV(y|\\mu, \\sigma, \\xi)} = \\begin{cases}\ne^{- \\left(1 + \\xi \\frac{y - \\mu}{\\sigma}\\right)_+^{-1/\\xi}}, \\xi\\neq0 \\\\\ne^{- e^{- \\frac{y - \\mu}{\\sigma}\n}}, \\xi=0\n\\end{cases}\n```\n\n\n\nIn our case we want $\\mu$ to vary with time. If we write $y_{it}$ for the observed hourly maximum at station $i$ during year $t$ we will then have\n\n\n```{=tex}\ny_{it} \\sim \\mathrm{GEV}(\\mu_{it}, \\sigma_i, \\xi_i), \\quad \\mu_{it}, \\sigma_i > 0, \\quad \\xi_i \\in (-0.5, 0.5),\n```\n\n\n\nwhere\n\n\n```{=tex}\n\\mu_{it} = \\mu_i \\cdot (1 + \\Delta_i \\cdot (t - t_0)),\n```\n\n\n\nand\n\n\n```{=tex}\n1 + \\xi_i \\frac{y_{it} - \\mu_{it}}{\\sigma_i} > 0, \\quad \\forall i, t.\n```\n\n\n\n# Maximum Likelihood Estimation\n\n## Transformed parameters\n\nHaving performed the Max step and saved the ML estimates we can easily load them by fetching the object `station_estimates`. Here we plot the distribution of transformed estimates.\n\n\n```{=tex}\n\\begin{aligned}\n\\psi &= \\log(\\mu) \\\\\n\\tau &= \\log(\\frac{\\sigma}{\\mu}) = \\log(\\sigma) - \\log(\\mu) \\\\\n\\phi &= h(\\xi) \\\\\n\\gamma &= d(\\Delta),\n\\end{aligned}\n```\n\n\nwhere the link functions for the shape and trend parameters are defined according to @johannesson2021\n\n\n\n```{=tex}\n\\begin{aligned}\nh(\\xi) &= a_\\phi + b_\\phi \\log\\left(-\\log\\left[1 - \\left(\\xi + \\frac12\\right)^{c_\\phi}\\right]\\right) \\\\\nc_\\phi &= 0.8 \\\\\nb_\\phi &= -\\frac{1}{c_\\phi}\\log\\left(1 - \\frac{1}{2^{c_\\phi}}\\right)\\left(1 - \\frac{1}{2^{c_\\phi}}\\right) 2^{c_\\phi - 1} \\\\\na_\\phi &= -b_\\phi \\log\\left(-\\log(1 - \\frac{1}{2^{c_\\phi}})\\right) \\\\\n\n\\newline\n\nd(\\Delta) &= \\frac12 \\delta_0 \\left(\\log(\\delta_0 + \\Delta) - \\log(\\delta_0 - \\Delta_i)\\right) \\\\\n\\delta_0 &= 0.008.\n\\end{aligned}\n```\n\n\n# Results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bggjphd)\nlibrary(tidyverse)\nlibrary(GGally)\nlibrary(cowplot)\nlibrary(arrow)\nlibrary(here)\ntheme_set(theme_bggj())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- station_estimates |> \n  select(station, par) |> \n  unnest(par) |> \n  inner_join(\n    stations\n  ) |> \n  select(station, proj_x, proj_y, name, value)\n```\n:::\n\n\n## Distributions\n\n### Transformed Scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_prior <- crossing(\n  name = c(\"phi\", \"gamma\"),\n  x = seq(-1, 1, len = 200)\n) |> \n  mutate(\n    x = ifelse(name == \"phi\", x * 0.8, x * 0.01),\n    y = ifelse(name == \"phi\", prior_shape(x) |> exp(), prior_trend(x) |> exp()),\n    y = ifelse(name == \"phi\", y * 6000, y * 0.05)\n  )\n\n\nd |> \n  ggplot(aes(value)) +\n  geom_histogram(bins = 60) +\n  geom_line(\n    data = d_prior,\n    aes(x = x, y = y * 1e3),\n    inherit.aes = F\n  ) +\n  facet_wrap(\"name\", scales = \"free\") +\n  labs(\n    x = NULL,\n    y = NULL,\n    title = \"Distributions of GEV parameters from Max step\",\n    subtitle = \"The superimposed curves are the implied prior distributions\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell fig.asp='1'}\n\n```{.r .cell-code}\nd |> \n  pivot_wider() |> \n  select(-station, -proj_x, -proj_y) |> \n  ggpairs(progress = FALSE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n### Original Scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_prior <- crossing(\n  name = c(\"phi\", \"gamma\"),\n  x = seq(-1, 1, len = 200)\n) |> \n  mutate(\n    x = ifelse(name == \"phi\", x * 0.8, x * 0.01),\n    y = ifelse(name == \"phi\", prior_shape(x) |> exp(), prior_trend(x) |> exp()),\n    y = ifelse(name == \"phi\", y * 2000000, y * 20),\n    x = ifelse(name == \"phi\", link_shape_inverse(x), link_trend_inverse(x)),\n    name = ifelse(name == \"phi\", \"xi\", \"delta\")\n  )\n\nd |> \n  pivot_wider() |> \n  mutate(mu = exp(psi),\n         sigma = exp(tau + psi),\n         xi = link_shape_inverse(phi),\n         delta = link_trend_inverse(gamma)) |> \n  select(-psi, -tau, -phi, -gamma, -proj_x, -proj_y) |> \n  pivot_longer(c(-station)) |> \n  mutate(name = fct_relevel(name, \"mu\", \"sigma\", \"xi\", \"delta\")) |> \n  ggplot(aes(value)) +\n  geom_histogram(bins = 100) +\n  geom_line(\n    data = d_prior,\n    aes(x = x, y = y),\n    inherit.aes = F\n  ) +\n  facet_wrap(\"name\", scales = \"free\") +\n  labs(\n    x = NULL,\n    y = NULL,\n    title = \"Distributions of backtransformed GEV parameters from Max step\",\n    subtitle = \"The superimposed curves are the implied prior distributions\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell fig.asp='1'}\n\n```{.r .cell-code}\nd |> \n  pivot_wider() |> \n  mutate(mu = exp(psi),\n         sigma = exp(tau + psi),\n         xi = link_shape_inverse(phi),\n         delta = link_trend_inverse(gamma)) |> \n  select(-psi, -tau, -phi, -gamma, -station, -proj_x, -proj_y) |> \n  ggpairs(progress = FALSE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## Spatial Distribution\n\n### Location\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  filter(name == \"psi\") |> \n  ggplot(aes(proj_x, proj_y, fill = value)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Psi\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  filter(name == \"psi\") |> \n  ggplot(aes(proj_x, proj_y, fill = exp(value))) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Mu\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### Scale\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  filter(name == \"tau\") |> \n  ggplot(aes(proj_x, proj_y, fill = value)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Tau\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  pivot_wider() |> \n  mutate(sigma = exp(tau + psi)) |> \n  ggplot(aes(proj_x, proj_y, fill = sigma)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Sigma\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### Shape\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  filter(name == \"phi\") |> \n  ggplot(aes(proj_x, proj_y, fill = value)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Phi\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  pivot_wider() |> \n  mutate(xi = link_shape_inverse(phi)) |> \n  ggplot(aes(proj_x, proj_y, fill = xi)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Xi\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### Trend\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  filter(name == \"gamma\") |> \n  ggplot(aes(proj_x, proj_y, fill = value)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Gamma\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd |> \n  pivot_wider() |> \n  mutate(delta = link_trend_inverse(gamma)) |> \n  ggplot(aes(proj_x, proj_y, fill = delta)) +\n  geom_raster(interpolate = TRUE) +\n  scale_x_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_x), pretty(d$proj_x))\n  ) +\n  scale_y_continuous(\n    expand = expansion(),\n    breaks = c(range(d$proj_y), pretty(d$proj_y))\n  ) +\n  scale_fill_viridis_c() +\n  labs(\n    x = \"X Projection\",\n    y = \"Y Projection\",\n    fill = NULL,\n    title = \"Spatial distribution of Delta\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}