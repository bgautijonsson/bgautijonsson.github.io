{
  "hash": "0d17b53c5fc511c042aee73e627f53aa",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"If It Bleeds, We Can Kill It\"\nsubtitle: \"Copulas in Stan: Episode 1\"\ndescription: \"This is the first post in what's going to be a series on using Copulas in Stan. Each post is going to be short to keep me from postponing writing them. In this post I lightly introduce the series and give a quick primer on copulas.\"\ndate: \"2024/09/15\"\ndraft: false\nformat: \n    html:\n        code-fold: show\n        toc: true\n        toc-location: left\nexecute: \n  echo: true\n  warning: false\neditor: source\nimage: images/predator.jpg\nengine: knitr\ncategories:\n    - stan\n    - copulas\n    - copulas in stan\n---\n\n\n\n# Introduction\n\nWelcome to the first post in my series on **copulas in Stan**. After StanCon2024 I was inspired to start writing short blog posts about this both to help get other started and also because I often don't really know how a thing works until I have to write about it or present it.\n\nIf you've ever felt intimidated by Sklar's theorem or how the Frank Copula is defined\n\n$$\nC_\\theta^F(\\mathbf u) = -\\frac1\\theta\\log\\left(1 + \\frac{(e^{-\\theta u_1} - 1)(e^{-\\theta u_2} - 1)}{e^{-\\theta} - 1}\\right),\n$$\n\njust remember Arnold's famous words from Predator\n\n![](images/predator.jpg)\n\n# What Are Copulas?\n\nAt their core, copulas are functions that **link univariate marginal distribution functions to form a multivariate distribution**. According to **Sklar's Theorem**, any multivariate joint distribution can be expressed in terms of its marginals and a copula that captures the dependence structure between variables.\n\nIf we let $\\mathbf{X} = (x_1, \\dots, x_n)$ be a multivariate random variable with marginal distribution functions $F_i$, the joint distribution function of $\\mathbf{X}$ can be written\n\n$$\nH(\\mathbf{X}) = C\\left( F_1(x_1), \\dots, F_n(x_n) \\right)\n$$\n\nwhere:\n\n* $H(\\mathbf{X})$ is the joint cumulative distribution function (CDF) of the collection of random variables $\\mathbf{X}$.\n* $F_i(x_i)$ are the marginal CDFs of each variate.\n* $C$ is **the copula function**.\n\n## Copulas as Densities\n\nCopulas are multivariate distribution functions for random variables with uniform marginal distributions, i.e. they are functions that map the unit cube $[0,1]^n$ to $[0,1]$. They can also be described using **copula density functions** when the marginals are continuous.\n\n$$\nh(x) = c(F_1(x_1), \\dots, F_d(x_d)) \\prod_{i=1}^d f_i(x_i),\n$$\n\nor (even better) a log-density function\n\n$$\n\\log h(\\mathbf x) = \\log c\\left(F_1(x_1), \\dots, F_d(x_d)\\right) + \\sum_{i=1}^d \\log f_i(x_i)\n$$\n\nNotice that $\\sum_{i=1}^d \\log f_i(x_i)$ is just the usual sum over marginal log-densities. Let's rewrite the other term a little bit and explicitly write the parameters we're conditioning on\n\n$$\n\\begin{aligned}\n\\log h(\\mathbf x) &= \\log c\\left(u_1, \\dots, u_d\\right) + \\sum_{i=1}^d \\log f_i(x_i \\vert \\theta_i) \\\\\nu_i &= F_i(x_i \\vert \\theta_i)\n\\end{aligned}\n$$\n\nThe main difference when modeling with a copula is \n\n1. We need to use the CDFs $F_i(x_i \\vert \\theta_i)$ as well as the pdfs.\n2. We need to code up some function $\\log c(u_1, \\dots, u_i)$ that takes as input the data $\\mathbf X$ after it's been transformed to $[0,1]^n$ by our CDFs and outputs a density.\n\n# The Copula We All Use\n\nThe simplest copula is the independence copula where we simply multiply together the uniform variates:\n\n$$\n\\begin{aligned}\nC(\\mathbf{u}) &= \\prod_{i=1}^n F(x_i\\vert \\theta_i) =  \\prod_{i=1}^n u_i \\\\\nc(\\mathbf{u}) &= 1 \\\\\n\\log c(\\mathbf{u}) &= 0\n\\end{aligned}\n$$\n\nWe see that if we use the independence copula, we just end up with the usual likelihood\n\n$$\n\\begin{aligned}\n\\log h(\\mathbf x) &= 0 + \\sum_{i=1}^d \\log f_i(x_i \\vert \\theta_i) \\\\\n&= \\log f_i(x_i \\vert \\theta_i)\n\\end{aligned}\n$$\n\nIn this way, we all use copulas whether we want to or not!\n\n# An Imaginary Stan Model\n\nThe Stan code below is just to give an idea of what a barebones model that uses copulas might look like in Stan. In future posts I'll write models that are based on this blueprint to implement different types of copulas.\n\n\n\n::: {.cell output.var='fake_model'}\n\n```{.stan .cell-code}\nfunctions {\n  real log_c(vector u, vector theta) {\n    return copula_log_density\n  }\n\n  real marginal_lpdf(real x, vector theta) {\n    return marginal_log_density\n  }\n\n  real marginal_cdf(real x, vector theta) {\n    return uniform_variable\n  }\n}\n\ndata {\n  int<lower = 0> n_obs;\n  matrix[n_obs, dim] X;\n}\n\nparameters {\n  vector[maginal_params] theta_marginal;\n  vector[copula_params] theta_copula;\n}\n\nmodel {\n  matrix[n_obs, dim] U;\n  for (i in 1:n_obs) {\n    for (j in 1:dim) {\n      target += marginal_lpdf(x[i, j] | theta_marginal)\n      U[i, j] = marginal_cdf(x[i, j] | theta_marginal)\n    }\n    target += log_c(U[i, ] | theta_copula);\n  }\n}\n```\n:::\n\n\n\n# Reading Material\n\nFor general purpose reading material on copulas, I recommend the following books:\n\n* [Elements of Copula Modeling with R (2018)](https://link.springer.com/book/10.1007/978-3-319-89635-9)\n* [An Introduction to Copulas (2006)](https://link.springer.com/book/10.1007/0-387-28678-0)\n* [Extremes in Nature: An Approach Using Copulas (2007)](https://link.springer.com/book/10.1007/1-4020-4415-1)\n* [Dependence Modeling with Copulas (2014)](https://www.taylorfrancis.com/books/mono/10.1201/b17116/dependence-modeling-copulas-harry-joe)\n\n\n# Coming up\n\nNext post will be about the Gaussian copula with a couple of examples in Stan.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}