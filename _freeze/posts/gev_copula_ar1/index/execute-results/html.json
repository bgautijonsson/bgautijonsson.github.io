{
  "hash": "6473f47b54c5ac968656ad700c4f1bc4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Applying a Gaussian AR(1) Copula to Generalized Extreme Value Margins\"\nsubtitle: \"A simulation study of the differences between AR(1) copula and i.i.d copula\"\ndescription: |\n  Another step in my PhD studies is to apply multivariate copulas to data with Generalized Extreme Value marginal distributions. This is important to enable us to model dependence on the data leve, as opposed to the latent *(parameter)* level. \nauthor: \n    -   name: \"Brynjólfur Gauti Guðrúnar Jónsson\"\n        url: \"bggj.is\"\n        affiliation: \"Tölfræði, Raunvísindadeild Háskóla Íslands\"\n        affiliation-url: \"https://www.hi.is/tolfraedi_0\"\ndate: \"2023/08/28\"\nbibliography: references.bib\ndraft: true\nformat: \n    html:\n        code-fold: show\n        toc: true\n        toc-location: left\nexecute: \n  echo: true\n  warning: false\neditor: source\ntheme: flatly\ntitle-block-banner: true\nimage: Figures/spatial_gamma.png\ncategories:\n    - english\n    - R\n    - phd\n    - stan\n    - bayesian\n    - spatial statistics\n    - copulas\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gt)\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(bggjphd)\ntheme_set(theme_bggj())\n```\n:::\n\n\n\n# Introduction\n\n[In a previous post, I wrote about applying the BYM2 model to spatially dependent Generalized Extreme Value (GEV) data](https://bggj.is/posts/icar_gev/) and mentioned in passing that I was working on applying copulas as well. In this post I will outline and show results from a simulation study I've been running where I:\n\n* Learn how to generate multivariate data that have GEV margins and dependence structures based on an AR(1) Gaussian copula\n* Learn how to code simple Gaussian copulas in Stan\n* Compare the model fits of the AR(1) copula to a model where I assume i.i.d. observations\n\n## Copulas\n\nIn the book *Elements of Copula Modeling with R*, @hofertElementsCopulaModeling2018 define a copula as\n\n> a multivariate distribution function with standard uniform univariate margins, that is, U(0, 1) margins.\n\nSo, a Copula is any multivariate distribution whose margins is U(0,1 ) distributed. A simple example is the *independence copula*\n\n$$\n\\Pi(u) = \\prod_{j=1}^{d}{u_j}, \\quad \\mathbf U \\in [0, 1]^d.\n$$\n\nThe central theorem of copula theory is Sklar's theorem [@sklarRandomVariablesDistribution1996] *[the original paper is from 1959]*. The theorem basically states that for any d-dimensional distribution function, $H$, with univariate margins $F_1, \\dots, F_d$, there exists a d-dimensional copula $C$ such that\n\n$$\nH(\\mathbf x) = C(F_1(x_1), \\dots, F_d(x_d)).\n$$\n\nAlternatively, we can write\n\n$$\nC(\\mathbf u) = H(F_1^{-1}(u_1), \\dots, F_d^{-1}(u_d))\n$$\n\n# Methods\n\n## Data\n\n[R scripts used for simulating the data](https://github.com/bgautijonsson/stan_experiments/blob/master/R/data.R)\n\nThe simulated data have GEV margins and an AR(1) Gaussian copula. The steps in simulating the data are as follows.\n\n1. Generate a correlation matrix, R, based on an AR(1) process\n2. Generate multivariate normal variates with mean zero and covariance matrix R.\n3. Transform to GEV by applying normal CDF and GEV quantile functions\n\n### 1. Correlation Matrix\n\nFirst, a correlation matrix is generated that encodes an AR(1) process with correlation $\\rho$. To create this correlation matrix, we specify the precision matrix, $Q$, via\n\n$$\nQ = \\frac{1}{1 - \\rho^2}\\begin{bmatrix}\n1 & -\\rho & \\dots & \\dots & \\vdots\\\\\n-\\rho & 1 + \\rho^2 & -\\rho & \\ddots & \\vdots \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\vdots & \\ddots &-\\rho & 1 + \\rho^2 & -\\rho \\\\\n\\vdots & \\dots & \\dots & -\\rho & 1 \n\\end{bmatrix}.\n$$\n\nThis gives us the correlation matrix, R, where\n\n$$\nR = Q^{-1} = \\begin{bmatrix}\n1 & \\rho & \\rho^2 & \\dots & \\rho^n\\\\\n\\rho & 1 & \\rho & \\ddots & \\rho^{n-1} \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\rho^{n-1} & \\ddots &\\rho & 1 & \\rho \\\\\n\\rho^n & \\dots & \\dots & \\rho & 1 \n\\end{bmatrix}.\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_AR_cor_matrix_1d <- function(n_id, rho = 0.5) {\n  P <- matrix(\n    0, \n    nrow = n_id,\n    ncol = n_id\n  )\n  diag(P) <- 1\n  for (i in seq(1, n_id - 1)) {\n    P[i, i + 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id)) {\n    P[i, i - 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id - 1)) {\n    P[i, i] <- 1 + rho^2\n  }\n  \n  P <- P / (1 - rho^2)\n  \n  P_cor <- solve(P)\n  P_cor\n}\n\nn_id <- 5\nrho <- 0.5\n\nR <- make_AR_cor_matrix_1d(n_id = n_id, rho = rho)\nR\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       [,1]  [,2] [,3]  [,4]   [,5]\n[1,] 1.0000 0.500 0.25 0.125 0.0625\n[2,] 0.5000 1.000 0.50 0.250 0.1250\n[3,] 0.2500 0.500 1.00 0.500 0.2500\n[4,] 0.1250 0.250 0.50 1.000 0.5000\n[5,] 0.0625 0.125 0.25 0.500 1.0000\n```\n\n\n:::\n:::\n\n\n\n### 2. Generating Multivariate Normal Data\n\nWe then use the well-known fact that if \n\n$$\n\\mathbf X \\sim \\mathrm{MVNorm}\\left(\\boldsymbol \\mu, \\Sigma\\right),\n$$\n\nthen\n\n$$\n\\boldsymbol X = \\boldsymbol \\mu +  L \\boldsymbol Z,\n$$\n\nwhere $\\boldsymbol Z \\sim \\mathrm{Normal}(\\boldsymbol 0,  I)$ and $L$ is the Cholesky decomposition of $R$, or $LL^T = \\Sigma$. \n\nIn our case, we want $\\mathbf X$ to have mean 0 and covariance matrix $R$, so we write\n\n$$\n\\mathbf X = L\\mathbf Z\n$$\n\nwhere $LL^T = R$.\n\nWe can skip the manual Cholesky factorization and simply use the `{mvtnorm}` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_gaussian_variables <- function(cor_matrix, n_replicates) {\n  mvtnorm::rmvnorm(\n    n = n_replicates,\n    sigma = cor_matrix\n  )\n}\n\nR |> \n  sample_gaussian_variables(n_replicates = 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         [,1]      [,2]     [,3]      [,4]      [,5]\n[1,] 1.304272 0.4298426 1.080875 0.7894652 -1.122778\n```\n\n\n:::\n:::\n\n\nWe will want more than one observation from each *\"site\"*, so we write a helped function for tidying this output into a tibble.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_mvgauss <- function(mvnorm_matrix) {\n  colnames(mvnorm_matrix) <- seq_len(ncol(mvnorm_matrix))\n  \n  mvnorm_matrix |> \n    dplyr::as_tibble() |> \n    dplyr::mutate(\n      replicate = dplyr::row_number(),\n      .before = `1`\n    ) |> \n    tidyr::pivot_longer(\n      c(-replicate),\n      names_to = \"id\", names_transform = as.numeric,\n      values_to = \"Z\"\n    )\n  \n}\n\nn_replicates <- 10\nmvnorm_data <- R |> \n  sample_gaussian_variables(n_replicates = n_replicates) |> \n  tidy_mvgauss()\n\nmvnorm_data |> \n  gt() |> \n  opt_interactive()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"vbfxsxapnl\" class=\".gt_table\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#vbfxsxapnl table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#vbfxsxapnl thead, #vbfxsxapnl tbody, #vbfxsxapnl tfoot, #vbfxsxapnl tr, #vbfxsxapnl td, #vbfxsxapnl th {\n  border-style: none;\n}\n\n#vbfxsxapnl p {\n  margin: 0;\n  padding: 0;\n}\n\n#vbfxsxapnl .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#vbfxsxapnl .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#vbfxsxapnl .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#vbfxsxapnl .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#vbfxsxapnl .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#vbfxsxapnl .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#vbfxsxapnl .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#vbfxsxapnl .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#vbfxsxapnl .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#vbfxsxapnl .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#vbfxsxapnl .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#vbfxsxapnl .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#vbfxsxapnl .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#vbfxsxapnl .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#vbfxsxapnl .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vbfxsxapnl .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#vbfxsxapnl .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#vbfxsxapnl .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#vbfxsxapnl .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vbfxsxapnl .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#vbfxsxapnl .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vbfxsxapnl .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#vbfxsxapnl .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vbfxsxapnl .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vbfxsxapnl .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vbfxsxapnl .gt_left {\n  text-align: left;\n}\n\n#vbfxsxapnl .gt_center {\n  text-align: center;\n}\n\n#vbfxsxapnl .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#vbfxsxapnl .gt_font_normal {\n  font-weight: normal;\n}\n\n#vbfxsxapnl .gt_font_bold {\n  font-weight: bold;\n}\n\n#vbfxsxapnl .gt_font_italic {\n  font-style: italic;\n}\n\n#vbfxsxapnl .gt_super {\n  font-size: 65%;\n}\n\n#vbfxsxapnl .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#vbfxsxapnl .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#vbfxsxapnl .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#vbfxsxapnl .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#vbfxsxapnl .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#vbfxsxapnl .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#vbfxsxapnl .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<div id=\"vbfxsxapnl\" class=\"reactable html-widget \" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"vbfxsxapnl\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"replicate\":[1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10],\"id\":[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],\"Z\":[-0.838842054133869,0.735920544274324,0.0257686834715345,-0.0155799106379054,0.237591341644598,-0.779602109716935,-1.74937774762662,-1.69896541747752,-0.693498111753161,-1.69121848490616,-0.662883123115692,-0.161964412472335,-0.685085709031592,-0.157860986879714,0.267569682315178,-0.396551752757115,-0.917550877860917,-1.82408114795539,-0.582749746467878,-0.496202317095872,0.873027049743963,-1.02157995850379,-0.967764390657677,-0.764371735772087,1.52020202479684,1.89090853670885,1.58725534048482,0.574391209613349,-0.45289200712016,0.0199308499513609,-0.553019511044624,0.301408138112527,0.565867015662667,0.0935196089064788,1.70241349727378,0.449603346572939,1.44472936846097,0.371681948306045,0.125517002817499,-1.16312290934035,-1.11787545023083,-0.107504539676316,0.00518327202733099,-0.0968483951362571,-0.839977204360986,0.132748781027452,-0.444638310201653,0.257456213586652,-0.540523600957891,0.511760244094851]},\"columns\":[{\"id\":\"replicate\",\"name\":\"replicate\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"id\",\"name\":\"id\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"Z\",\"name\":\"Z\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"-0.838842054\",\"0.735920544\",\"0.025768683\",\"-0.015579911\",\"0.237591342\",\"-0.779602110\",\"-1.749377748\",\"-1.698965417\",\"-0.693498112\",\"-1.691218485\",\"-0.662883123\",\"-0.161964412\",\"-0.685085709\",\"-0.157860987\",\"0.267569682\",\"-0.396551753\",\"-0.917550878\",\"-1.824081148\",\"-0.582749746\",\"-0.496202317\",\"0.873027050\",\"-1.021579959\",\"-0.967764391\",\"-0.764371736\",\"1.520202025\",\"1.890908537\",\"1.587255340\",\"0.574391210\",\"-0.452892007\",\"0.019930850\",\"-0.553019511\",\"0.301408138\",\"0.565867016\",\"0.093519609\",\"1.702413497\",\"0.449603347\",\"1.444729368\",\"0.371681948\",\"0.125517003\",\"-1.163122909\",\"-1.117875450\",\"-0.107504540\",\"0.005183272\",\"-0.096848395\",\"-0.839977204\",\"0.132748781\",\"-0.444638310\",\"0.257456214\",\"-0.540523601\",\"0.511760244\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}}],\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"pageSizeOptions\":[10,25,50,100],\"paginationType\":\"numbers\",\"showPagination\":true,\"showPageInfo\":true,\"minRows\":1,\"showSortable\":true,\"height\":\"auto\",\"theme\":{\"color\":\"#333333\",\"backgroundColor\":\"#FFFFFF\",\"stripedColor\":\"rgba(128,128,128,0.05)\",\"style\":{\"fontFamily\":\"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\"},\"headerStyle\":{\"borderTopStyle\":\"solid\",\"borderTopWidth\":\"2px\",\"borderTopColor\":\"#D3D3D3\",\"borderBottomStyle\":\"solid\",\"borderBottomWidth\":\"2px\",\"borderBottomColor\":\"#D3D3D3\"}},\"elementId\":\"vbfxsxapnl\",\"dataKey\":\"23cbc57c80e9db727b4d199aaf25a303\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[\"tag.attribs.columns.0.style\",\"tag.attribs.columns.1.style\",\"tag.attribs.columns.2.style\"],\"jsHooks\":[]}</script>\n</div>\n```\n\n:::\n:::\n\n\n\n### 3. Transforming to Multivariate GEV\n\nNow our data, $\\mathbf X$, is multivariate normal with dependence structure according to an AR(1) process, but marginally each $X_1$ is standard normal. To transform this data to a GEV dataset, we simply use the standard normal CDF on each $X_i$ to transform it to $[0, 1]$, then we use the GEV quantile function to transform that to a GEV distributed variable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmvnorm_to_gev <- function(mvnorm_data, gev_params) {\n  \n  mvnorm_data |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr:::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\ngev_data <- mvnorm_data |> \n  mvnorm_to_gev(gev_params = gev_params)\n\ngev_data |> \n  select(-mu, -sigma, -xi) |> \n  gt() |> \n  opt_interactive()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"dpebnsrahf\" class=\".gt_table\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#dpebnsrahf table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#dpebnsrahf thead, #dpebnsrahf tbody, #dpebnsrahf tfoot, #dpebnsrahf tr, #dpebnsrahf td, #dpebnsrahf th {\n  border-style: none;\n}\n\n#dpebnsrahf p {\n  margin: 0;\n  padding: 0;\n}\n\n#dpebnsrahf .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#dpebnsrahf .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#dpebnsrahf .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#dpebnsrahf .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#dpebnsrahf .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#dpebnsrahf .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#dpebnsrahf .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#dpebnsrahf .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#dpebnsrahf .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#dpebnsrahf .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#dpebnsrahf .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#dpebnsrahf .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#dpebnsrahf .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#dpebnsrahf .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#dpebnsrahf .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dpebnsrahf .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#dpebnsrahf .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#dpebnsrahf .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#dpebnsrahf .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dpebnsrahf .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#dpebnsrahf .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dpebnsrahf .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#dpebnsrahf .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dpebnsrahf .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dpebnsrahf .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dpebnsrahf .gt_left {\n  text-align: left;\n}\n\n#dpebnsrahf .gt_center {\n  text-align: center;\n}\n\n#dpebnsrahf .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#dpebnsrahf .gt_font_normal {\n  font-weight: normal;\n}\n\n#dpebnsrahf .gt_font_bold {\n  font-weight: bold;\n}\n\n#dpebnsrahf .gt_font_italic {\n  font-style: italic;\n}\n\n#dpebnsrahf .gt_super {\n  font-size: 65%;\n}\n\n#dpebnsrahf .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#dpebnsrahf .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#dpebnsrahf .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#dpebnsrahf .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#dpebnsrahf .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#dpebnsrahf .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#dpebnsrahf .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<div id=\"dpebnsrahf\" class=\"reactable html-widget \" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"dpebnsrahf\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"replicate\":[1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10],\"id\":[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],\"Z\":[-0.838842054133869,0.735920544274324,0.0257686834715345,-0.0155799106379054,0.237591341644598,-0.779602109716935,-1.74937774762662,-1.69896541747752,-0.693498111753161,-1.69121848490616,-0.662883123115692,-0.161964412472335,-0.685085709031592,-0.157860986879714,0.267569682315178,-0.396551752757115,-0.917550877860917,-1.82408114795539,-0.582749746467878,-0.496202317095872,0.873027049743963,-1.02157995850379,-0.967764390657677,-0.764371735772087,1.52020202479684,1.89090853670885,1.58725534048482,0.574391209613349,-0.45289200712016,0.0199308499513609,-0.553019511044624,0.301408138112527,0.565867015662667,0.0935196089064788,1.70241349727378,0.449603346572939,1.44472936846097,0.371681948306045,0.125517002817499,-1.16312290934035,-1.11787545023083,-0.107504539676316,0.00518327202733099,-0.0968483951362571,-0.839977204360986,0.132748781027452,-0.444638310201653,0.257456213586652,-0.540523600957891,0.511760244094851],\"U\":[0.20077897407215,0.769110473116809,0.510279079740086,0.493784766363703,0.593900966693018,0.217812556867556,0.0401128723679771,0.0446628498895528,0.243998505204445,0.0453975409144492,0.253702705702293,0.435666939263814,0.246644918848604,0.437283170243163,0.605484714864777,0.345849018545748,0.179427022514119,0.0340699025703967,0.280030889654523,0.309875838190323,0.808675832945678,0.153489873614208,0.166581025832996,0.222322873586756,0.93576989565606,0.97068172265958,0.943772587244681,0.717148449991673,0.325313253355008,0.507950732336581,0.290125024988631,0.61844835531071,0.714257907238826,0.537254613846867,0.9556610591918,0.673501762697159,0.925733041347448,0.644935166585019,0.549942867407798,0.12238981920154,0.131810095705926,0.457194362027699,0.502067817103418,0.461423395390294,0.200460583937946,0.552803968725663,0.32829057859639,0.601586693633563,0.294417994710031,0.695590591309735],\"y\":[4.61270088473726,10.292954693913,7.21280639872279,7.06432909081315,8.02092869250737,4.7620162047883,2.69247641239193,2.78333082690064,4.98551871383578,2.79742906791106,5.06690262400358,6.56100057633001,5.0077793683975,6.57465400580371,8.14212586784137,5.82077367072186,4.41968596097224,2.56061056295164,5.28487327855353,5.52867275984235,11.0279375948844,4.17354518322048,4.29963457696841,4.80098317118733,15.3471988379662,18.634664984808,15.8910871759442,9.49235553003182,5.65408764002376,7.19166848152655,5.36761802938953,8.28108746738126,9.45193980456587,7.46243249987788,16.8753646121944,8.91792530442612,14.7593740415799,8.57720711506798,7.58314904659169,3.85403228064959,3.95431700158665,6.74430501077826,7.13852719108893,6.78071013490713,4.60987415171019,7.61068918688009,5.6782537619253,8.10103998582916,5.40270713304784,9.1994819808429]},\"columns\":[{\"id\":\"replicate\",\"name\":\"replicate\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"id\",\"name\":\"id\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"Z\",\"name\":\"Z\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"-0.838842054\",\"0.735920544\",\"0.025768683\",\"-0.015579911\",\"0.237591342\",\"-0.779602110\",\"-1.749377748\",\"-1.698965417\",\"-0.693498112\",\"-1.691218485\",\"-0.662883123\",\"-0.161964412\",\"-0.685085709\",\"-0.157860987\",\"0.267569682\",\"-0.396551753\",\"-0.917550878\",\"-1.824081148\",\"-0.582749746\",\"-0.496202317\",\"0.873027050\",\"-1.021579959\",\"-0.967764391\",\"-0.764371736\",\"1.520202025\",\"1.890908537\",\"1.587255340\",\"0.574391210\",\"-0.452892007\",\"0.019930850\",\"-0.553019511\",\"0.301408138\",\"0.565867016\",\"0.093519609\",\"1.702413497\",\"0.449603347\",\"1.444729368\",\"0.371681948\",\"0.125517003\",\"-1.163122909\",\"-1.117875450\",\"-0.107504540\",\"0.005183272\",\"-0.096848395\",\"-0.839977204\",\"0.132748781\",\"-0.444638310\",\"0.257456214\",\"-0.540523601\",\"0.511760244\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"U\",\"name\":\"U\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"0.20077897\",\"0.76911047\",\"0.51027908\",\"0.49378477\",\"0.59390097\",\"0.21781256\",\"0.04011287\",\"0.04466285\",\"0.24399851\",\"0.04539754\",\"0.25370271\",\"0.43566694\",\"0.24664492\",\"0.43728317\",\"0.60548471\",\"0.34584902\",\"0.17942702\",\"0.03406990\",\"0.28003089\",\"0.30987584\",\"0.80867583\",\"0.15348987\",\"0.16658103\",\"0.22232287\",\"0.93576990\",\"0.97068172\",\"0.94377259\",\"0.71714845\",\"0.32531325\",\"0.50795073\",\"0.29012502\",\"0.61844836\",\"0.71425791\",\"0.53725461\",\"0.95566106\",\"0.67350176\",\"0.92573304\",\"0.64493517\",\"0.54994287\",\"0.12238982\",\"0.13181010\",\"0.45719436\",\"0.50206782\",\"0.46142340\",\"0.20046058\",\"0.55280397\",\"0.32829058\",\"0.60158669\",\"0.29441799\",\"0.69559059\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"y\",\"name\":\"y\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"4.612701\",\"10.292955\",\"7.212806\",\"7.064329\",\"8.020929\",\"4.762016\",\"2.692476\",\"2.783331\",\"4.985519\",\"2.797429\",\"5.066903\",\"6.561001\",\"5.007779\",\"6.574654\",\"8.142126\",\"5.820774\",\"4.419686\",\"2.560611\",\"5.284873\",\"5.528673\",\"11.027938\",\"4.173545\",\"4.299635\",\"4.800983\",\"15.347199\",\"18.634665\",\"15.891087\",\"9.492356\",\"5.654088\",\"7.191668\",\"5.367618\",\"8.281087\",\"9.451940\",\"7.462432\",\"16.875365\",\"8.917925\",\"14.759374\",\"8.577207\",\"7.583149\",\"3.854032\",\"3.954317\",\"6.744305\",\"7.138527\",\"6.780710\",\"4.609874\",\"7.610689\",\"5.678254\",\"8.101040\",\"5.402707\",\"9.199482\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}}],\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"pageSizeOptions\":[10,25,50,100],\"paginationType\":\"numbers\",\"showPagination\":true,\"showPageInfo\":true,\"minRows\":1,\"showSortable\":true,\"height\":\"auto\",\"theme\":{\"color\":\"#333333\",\"backgroundColor\":\"#FFFFFF\",\"stripedColor\":\"rgba(128,128,128,0.05)\",\"style\":{\"fontFamily\":\"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\"},\"headerStyle\":{\"borderTopStyle\":\"solid\",\"borderTopWidth\":\"2px\",\"borderTopColor\":\"#D3D3D3\",\"borderBottomStyle\":\"solid\",\"borderBottomWidth\":\"2px\",\"borderBottomColor\":\"#D3D3D3\"}},\"elementId\":\"dpebnsrahf\",\"dataKey\":\"75d43d40a736fc1f6512ba320113afef\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[\"tag.attribs.columns.0.style\",\"tag.attribs.columns.1.style\",\"tag.attribs.columns.2.style\",\"tag.attribs.columns.3.style\",\"tag.attribs.columns.4.style\"],\"jsHooks\":[]}</script>\n</div>\n```\n\n:::\n:::\n\n\n## Checking the data\n\nLet's create a function that plots heat maps for each of the three representations of the data\n\n* Z: The multivariate normal\n* U: The multivariate uniform\n* y: The multivariate GEV\n\nWe want the color scales to be free, so we use `group_map()` and `wrap_plots()` instead of `facet_wrap()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- function(data) {\n  data |> \n    select(replicate, id, Z, U, y) |> \n    pivot_longer(c(-replicate, -id)) |> \n    mutate(\n      name = fct_relevel(name, \"Z\", \"U\", \"y\"),\n      name2 = name\n    ) |> \n    group_by(name) |> \n    group_map(\n      function(data, ...) {\n        data |> \n          ggplot(aes(id, replicate, fill = value)) +\n          geom_raster() +\n          coord_cartesian(expand = FALSE) +\n          theme(legend.position = \"none\") +\n          labs(\n            subtitle = data$name2\n          )\n      }\n    ) |> \n    wrap_plots() +\n    plot_layout(nrow = 1) +\n    plot_annotation(\n      title = \"Heatmaps of the three data representations\",\n      subtitle = \"Z: Normal | U: Uniform | y: GEV\"\n    )\n}\n```\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ngev_data |> \n  plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=100%}\n:::\n:::\n\n\n\nIt's nice to wrap this process in a single function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_data <- function(gev_params, n_replicate, rho) {\n  \n  make_AR_cor_matrix_1d(n_id = nrow(gev_params), rho = rho) |> \n    sample_gaussian_variables(n_replicates = n_replicate) |> \n    tidy_mvgauss() |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n```\n:::\n\n\nLet's see how the data look if we make it larger and increase the correlation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_id <- 40\nn_replicates <- 100\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\nd <- make_data(gev_params, n_replicates, rho = 0.95)\n```\n:::\n\n\n\nWe see that with higher neighbor correlations we get obvious horizontal stripes corresponding to a large amount of dependence within each replicate.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nd |> plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=100%}\n:::\n:::\n\n\n\n## Modeling\n\n[R scripts used for modeling](https://github.com/bgautijonsson/stan_experiments/blob/master/R/modeling.R)\n\nI wrote two different models in stan.\n\n1. A model that wraps the GEV margins into an AR(1) Gaussian copula\n2. A model that assumes i.i.d. GEV margins\n\n::: {.panel-tabset}\n\n### AR(1) Copula\n\n\n::: {.cell .column-page-inset output.var='model1'}\n\n```{.stan .cell-code}\nfunctions {\n  real gev_lpdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return -log(sigma) - z - exp(-z);\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n\n  real normal_copula_prec_lpdf(vector U, matrix L) {\n    int N = rows(U);\n    vector[N] Z = inv_Phi(U);\n    vector[N] mu = rep_vector(0, N);\n    matrix[N, N] I = diag_matrix(rep_vector(1, N));\n    \n    return multi_normal_prec_lpdf(Z | mu, L) - multi_normal_prec_lpdf(Z | mu, I);\n  }\n}\n\ndata {\n  int<lower = 0> n_replicate;\n  int<lower = 0> n_id;\n  array[n_replicate, n_id] real y;\n  array[n_replicate, n_id] real y_test;\n}\n\nparameters {\n  real<lower = 0> mu;\n  real<lower = 0> sigma;\n  real<lower = 0, upper = 0.5> xi;\n  real<lower = -1, upper = 1> rho;\n}\n\nmodel {\n  # Defining the precision matrix Q\n  real rho_scaler = pow(1 - rho^2, -1);\n  real diag_inside = rho^2 * rho_scaler;\n  real off_diag = -rho * rho_scaler;\n  matrix[n_id, n_id] Omega = diag_matrix(rep_vector(rho_scaler, n_id));\n  Omega[2:(n_id - 1), 2:(n_id - 1)] = add_diag(Omega[2:(n_id - 1), 2:(n_id - 1)], diag_inside);\n  for (i in 1:n_id) {\n    if (i > 1) {\n      Omega[i, i - 1] = off_diag;\n    }\n    if (i < n_id) {\n      Omega[i, i + 1] = off_diag;\n    }\n  }\n  \n  \n  for (i in 1:n_replicate) {\n    vector[n_id] U;\n    for (j in 1:n_id) {\n      U[j] = gev_cdf(y[i, j] | mu, sigma, xi);\n      target += gev_lpdf(y[i, j] | mu, sigma, xi);\n    }\n    target += normal_copula_prec_lpdf(U | Omega);\n  }\n}\n\ngenerated quantities {\n  real log_lik = 0;\n  {\n    # Creating Q inside brackets, since I don't want to include it in the model output\n    real rho_scaler = pow(1 - rho^2, -1);\n    real diag_inside = rho^2 * rho_scaler;\n    real off_diag = -rho * rho_scaler;\n    matrix[n_id, n_id] Omega = diag_matrix(rep_vector(rho_scaler, n_id));\n    Omega[2:(n_id - 1), 2:(n_id - 1)] = add_diag(Omega[2:(n_id - 1), 2:(n_id - 1)], diag_inside);\n    for (i in 1:n_id) {\n      if (i > 1) {\n        Omega[i, i - 1] = off_diag;\n      }\n      if (i < n_id) {\n        Omega[i, i + 1] = off_diag;\n      }\n    }\n    \n    for (i in 1:n_replicate) {\n      vector[n_id] U;\n      for (j in 1:n_id) {\n        U[j] = gev_cdf(y_test[i, j] | mu, sigma, xi);\n        log_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n      }\n      log_lik += normal_copula_prec_lpdf(U | Omega);\n    }\n  }\n}\n```\n:::\n\n\n### i.i.d.\n\n\n::: {.cell .column-page-inset output.var='model2'}\n\n```{.stan .cell-code}\nfunctions {\n  real gev_lpdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return -log(sigma) - z - exp(-z);\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n}\n\ndata {\n  int<lower = 0> n_replicate;\n  int<lower = 0> n_id;\n  array[n_replicate, n_id] real y;\n  array[n_replicate, n_id] real y_test;\n}\n\nparameters {\n  real<lower = 0> mu;\n  real<lower = 0> sigma;\n  real<lower = 0, upper = 0.5> xi;\n}\n\ntransformed parameters {\n  \n}\n\nmodel {\n  for (i in 1:n_replicate) {\n    for (j in 1:n_id) {\n      target += gev_lpdf(y[i, j] | mu, sigma, xi);\n    }\n  }\n}\n\ngenerated quantities {\n  real log_lik = 0;\n  {\n    for (i in 1:n_replicate) {\n      for (j in 1:n_id) {\n        log_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n      }\n    }\n  }\n}\n\n```\n:::\n\n\n:::\n\n# Results\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/param_means.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/elppd.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/diff_elppd.png){.column-page}\n\n\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/core-js-2.5.3/shim.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react-dom.min.js\"></script>\n<script src=\"../../site_libs/reactwidget-1.0.0/react-tools.js\"></script>\n<script src=\"../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/reactable-0.4.4/reactable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/reactable-binding-0.4.4/reactable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}