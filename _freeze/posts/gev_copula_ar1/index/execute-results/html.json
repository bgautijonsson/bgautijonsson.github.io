{
  "hash": "98ea9e831c09c8e33f13895420bfd9e6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Applying a Gaussian AR(1) Copula to Generalized Extreme Value Margins\"\nsubtitle: \"A simulation study of the differences between AR(1) copula and i.i.d copula\"\ndescription: |\n  Another step in my PhD studies is to apply multivariate copulas to data with Generalized Extreme Value marginal distributions. This is important to enable us to model dependence on the data leve, as opposed to the latent *(parameter)* level. \nauthor: \n    -   name: \"Brynjólfur Gauti Guðrúnar Jónsson\"\n        url: \"bggj.is\"\n        affiliation: \"Tölfræði, Raunvísindadeild Háskóla Íslands\"\n        affiliation-url: \"https://www.hi.is/tolfraedi_0\"\ndate: \"2023/08/28\"\nbibliography: references.bib\ndraft: true\nformat: \n    html:\n        code-fold: show\n        toc: true\n        toc-location: left\nexecute: \n  echo: true\n  warning: false\neditor: source\ntheme: flatly\ntitle-block-banner: true\nimage: Figures/spatial_gamma.png\ncategories:\n    - english\n    - R\n    - phd\n    - stan\n    - bayesian\n    - spatial statistics\n    - copulas\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gt)\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(bggjphd)\ntheme_set(theme_bggj())\n```\n:::\n\n\n\n# Introduction\n\n[In a previous post, I wrote about applying the BYM2 model to spatially dependent Generalized Extreme Value (GEV) data](https://bggj.is/posts/icar_gev/) and mentioned in passing that I was working on applying copulas as well. In this post I will outline and show results from a simulation study I've been running where I:\n\n* Learn how to generate multivariate data that have GEV margins and dependence structures based on an AR(1) Gaussian copula\n* Learn how to code simple Gaussian copulas in Stan\n* Compare the model fits of the AR(1) copula to a model where I assume i.i.d. observations\n\n## Copulas\n\nIn the book *Elements of Copula Modeling with R*, @hofertElementsCopulaModeling2018 define a copula as\n\n> a multivariate distribution function with standard uniform univariate margins, that is, U(0, 1) margins.\n\nSo, a Copula is any multivariate distribution whose margins is U(0,1 ) distributed. A simple example is the *independence copula*\n\n$$\n\\Pi(u) = \\prod_{j=1}^{d}{u_j}, \\quad \\mathbf U \\in [0, 1]^d.\n$$\n\nThe central theorem of copula theory is Sklar's theorem [@sklarRandomVariablesDistribution1996] *[the original paper is from 1959]*. The theorem basically states that for any d-dimensional distribution function, $H$, with univariate margins $F_1, \\dots, F_d$, there exists a d-dimensional copula $C$ such that\n\n$$\nH(\\mathbf x) = C(F_1(x_1), \\dots, F_d(x_d)).\n$$\n\nAlternatively, we can write\n\n$$\nC(\\mathbf u) = H(F_1^{-1}(u_1), \\dots, F_d^{-1}(u_d))\n$$\n\n### Gaussian Copula\n\nThe Gaussian family of copulas can be written\n\n$$\nC(\\mathbf u | R) = \\Phi_d\\left(\\Phi^{-1}(u_1), \\dots, \\Phi^{-1}(u_d) \\vert R \\right), \\quad \\mathbf u \\in [0, 1]^d,\n$$\n\nwhere R is a $d\\times d$ correlation matrix, $\\Phi_d$ is the CDF of a d-dimensional multivariate Gaussian with mean $\\mathbf 0$ and covariance matrix $R$, and $\\Phi$ is the CDF of a standard Gaussian.\n\nIts density is\n\n$$\nc(\\mathbf u \\vert R) = \\frac{\\phi_d\\left(\\Phi^{-1}(u_1), \\dots, \\Phi^{-1}(u_d) \\vert R \\right)}{ \\prod_{j=1}^{d}{\\phi\\left( \\Phi^{-1}(u_j) \\right)}}, \\quad \\mathbf u \\in [0, 1]^d,\n$$\n\nwhere $\\phi_d$ is the density of the same multivariate Gaussian, and $\\phi$ is the density of a standard gaussian.\n\n#### Sampling from the Gaussian copula\n\nGiven the correlation matrix, $R$:\n\n1. Compute the Cholesky factor $L$ of the correlation matrix, $R$.\n2. Sample $Z_1, \\dots, Z_d \\overset{iid}{\\sim}\\mathrm{Normal}(0, 1)$.\n3. Compute $X = LZ$.\n4. Return $\\mathbf u = \\left(\\Phi(X_1), \\dots, \\Phi(X_d)\\right)$\n\nWe can then make the margins $u_1, \\dots, u_d$ follow any distribution *(f.ex. the GEV distribution)* by applying its quantile function.\n\n### Example\n\nLet's sample from a two-dimensional process with GEV(8, 2, 0.05) margins and a Gaussian copula with correlation $\\rho = 0.7$.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code  code-fold=\"true\"}\nR <- matrix(c(1, 0.7, 0.7, 1), nrow = 2)\nX <- mvtnorm::rmvnorm(\n  n = 100,\n  sigma = R\n)\n\nX |> \n  as_tibble() |> \n  mutate(\n    id = row_number()\n  ) |> \n  pivot_longer(c(-id), names_to = \"variable\", values_to = \"Z\") |> \n  mutate(\n    U = pnorm(Z),\n    Y = evd::qgev(U, loc = 8, scale = 2, shape = 0.05)\n  ) |> \n  pivot_longer(c(-id, -variable)) |> \n  pivot_wider(names_from = variable, values_from = value) |>\n  mutate(\n    name = fct_relevel(name, \"Z\", \"U\", \"Y\") |> \n      fct_recode(\n        \"Z (Gaussian)\" = \"Z\",\n        \"U (Uniform)\" = \"U\",\n        \"Y (GEV)\" = \"Y\"\n      )\n  ) |> \n  group_by(name2 = name) |> \n  group_map(\n    function(data, ...) {\n      data |> \n        ggplot(aes(V1, V2)) +\n        geom_density_2d_filled() +\n        geom_point(col = \"grey70\") +\n        coord_cartesian(expand = FALSE) +\n        theme(legend.position = \"none\") +\n        labs(\n          x = NULL,\n          y = NULL,\n          subtitle = data$name\n        )\n    }\n  ) |> \n  wrap_plots() +\n  plot_annotation(\n    title = \"The stages in generating 2d GEV(8, 2, 0.05) data with a Gaussian copula\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=100%}\n:::\n:::\n\n\n\n# Methods\n\n## Data\n\n[R scripts used for simulating the data](https://github.com/bgautijonsson/stan_experiments/blob/master/R/data.R)\n\nThe simulated data have GEV margins and an AR(1) Gaussian copula. The steps in simulating the data are as follows.\n\n1. Generate a correlation matrix, R, based on an AR(1) process\n2. Generate multivariate normal variates with mean zero and covariance matrix R.\n3. Transform to GEV by applying normal CDF and GEV quantile functions\n\n### 1. Correlation Matrix\n\nFirst, a correlation matrix is generated that encodes an AR(1) process with correlation $\\rho$. To create this correlation matrix, we specify the precision matrix, $Q$, via\n\n$$\nQ = \\frac{1}{1 - \\rho^2}\\begin{bmatrix}\n1 & -\\rho & \\dots & \\dots & \\vdots\\\\\n-\\rho & 1 + \\rho^2 & -\\rho & \\ddots & \\vdots \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\vdots & \\ddots &-\\rho & 1 + \\rho^2 & -\\rho \\\\\n\\vdots & \\dots & \\dots & -\\rho & 1 \n\\end{bmatrix}.\n$$\n\nThis gives us the correlation matrix, R, where\n\n$$\nR = Q^{-1} = \\begin{bmatrix}\n1 & \\rho & \\rho^2 & \\dots & \\rho^n\\\\\n\\rho & 1 & \\rho & \\ddots & \\rho^{n-1} \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\rho^{n-1} & \\ddots &\\rho & 1 & \\rho \\\\\n\\rho^n & \\dots & \\dots & \\rho & 1 \n\\end{bmatrix}.\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_AR_cor_matrix_1d <- function(n_id, rho = 0.5) {\n  P <- matrix(\n    0, \n    nrow = n_id,\n    ncol = n_id\n  )\n  diag(P) <- 1\n  for (i in seq(1, n_id - 1)) {\n    P[i, i + 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id)) {\n    P[i, i - 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id - 1)) {\n    P[i, i] <- 1 + rho^2\n  }\n  \n  P <- P / (1 - rho^2)\n  \n  P_cor <- solve(P)\n  P_cor\n}\n\nn_id <- 5\nrho <- 0.5\n\nR <- make_AR_cor_matrix_1d(n_id = n_id, rho = rho)\nR\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       [,1]  [,2] [,3]  [,4]   [,5]\n[1,] 1.0000 0.500 0.25 0.125 0.0625\n[2,] 0.5000 1.000 0.50 0.250 0.1250\n[3,] 0.2500 0.500 1.00 0.500 0.2500\n[4,] 0.1250 0.250 0.50 1.000 0.5000\n[5,] 0.0625 0.125 0.25 0.500 1.0000\n```\n\n\n:::\n:::\n\n\n\n### 2. Generating Multivariate Normal Data\n\nWe then use the well-known fact that if \n\n$$\n\\mathbf X \\sim \\mathrm{MVNorm}\\left(\\boldsymbol \\mu, \\Sigma\\right),\n$$\n\nthen\n\n$$\n\\boldsymbol X = \\boldsymbol \\mu +  L \\boldsymbol Z,\n$$\n\nwhere $\\boldsymbol Z \\sim \\mathrm{Normal}(\\boldsymbol 0,  I)$ and $L$ is the Cholesky decomposition of $R$, or $LL^T = \\Sigma$. \n\nIn our case, we want $\\mathbf X$ to have mean 0 and covariance matrix $R$, so we write\n\n$$\n\\mathbf X = L\\mathbf Z\n$$\n\nwhere $LL^T = R$.\n\nWe can skip the manual Cholesky factorization and simply use the `{mvtnorm}` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_gaussian_variables <- function(cor_matrix, n_replicates) {\n  mvtnorm::rmvnorm(\n    n = n_replicates,\n    sigma = cor_matrix\n  )\n}\n\nR |> \n  sample_gaussian_variables(n_replicates = 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]       [,2]       [,3]     [,4]        [,5]\n[1,] -2.565599 -0.7567668 -0.2584833 1.430638 0.004611752\n```\n\n\n:::\n:::\n\n\nWe will want more than one observation from each *\"site\"*, so we write a helped function for tidying this output into a tibble.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_mvgauss <- function(mvnorm_matrix) {\n  colnames(mvnorm_matrix) <- seq_len(ncol(mvnorm_matrix))\n  \n  mvnorm_matrix |> \n    dplyr::as_tibble() |> \n    dplyr::mutate(\n      replicate = dplyr::row_number(),\n      .before = `1`\n    ) |> \n    tidyr::pivot_longer(\n      c(-replicate),\n      names_to = \"id\", names_transform = as.numeric,\n      values_to = \"Z\"\n    )\n  \n}\n\nn_replicates <- 10\nmvnorm_data <- R |> \n  sample_gaussian_variables(n_replicates = n_replicates) |> \n  tidy_mvgauss()\n\nmvnorm_data |> \n  gt() |> \n  opt_interactive()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"mqasmdehcw\" class=\".gt_table\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#mqasmdehcw table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#mqasmdehcw thead, #mqasmdehcw tbody, #mqasmdehcw tfoot, #mqasmdehcw tr, #mqasmdehcw td, #mqasmdehcw th {\n  border-style: none;\n}\n\n#mqasmdehcw p {\n  margin: 0;\n  padding: 0;\n}\n\n#mqasmdehcw .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#mqasmdehcw .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#mqasmdehcw .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#mqasmdehcw .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#mqasmdehcw .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#mqasmdehcw .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#mqasmdehcw .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#mqasmdehcw .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#mqasmdehcw .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#mqasmdehcw .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#mqasmdehcw .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#mqasmdehcw .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#mqasmdehcw .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#mqasmdehcw .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#mqasmdehcw .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mqasmdehcw .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#mqasmdehcw .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#mqasmdehcw .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#mqasmdehcw .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mqasmdehcw .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#mqasmdehcw .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mqasmdehcw .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#mqasmdehcw .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mqasmdehcw .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mqasmdehcw .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mqasmdehcw .gt_left {\n  text-align: left;\n}\n\n#mqasmdehcw .gt_center {\n  text-align: center;\n}\n\n#mqasmdehcw .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#mqasmdehcw .gt_font_normal {\n  font-weight: normal;\n}\n\n#mqasmdehcw .gt_font_bold {\n  font-weight: bold;\n}\n\n#mqasmdehcw .gt_font_italic {\n  font-style: italic;\n}\n\n#mqasmdehcw .gt_super {\n  font-size: 65%;\n}\n\n#mqasmdehcw .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#mqasmdehcw .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#mqasmdehcw .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#mqasmdehcw .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#mqasmdehcw .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#mqasmdehcw .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#mqasmdehcw .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<div id=\"mqasmdehcw\" class=\"reactable html-widget \" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"mqasmdehcw\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"replicate\":[1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10],\"id\":[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],\"Z\":[0.403539546968351,-1.08135955962246,-0.745394516864418,-0.16235989607067,-0.80485773949381,-0.439984282237938,0.229021083306807,-0.180020470066276,-1.7557996304722,-1.38859916022831,0.125032315344734,-0.689956336897874,0.584096510995895,0.451655620321786,-0.945607352160775,1.06396871165744,-0.164732651579674,-0.584421991997708,0.913655047733595,0.972396970898358,1.25960373666065,0.600482388522512,0.744063902427303,0.547360162459707,-0.132018556488247,-0.214131314719595,-0.890305430895083,0.27327054212247,0.518996223878257,0.907387352660364,-0.755827573855755,-1.49846080781037,0.500904729727637,-0.405345784000656,-0.767057106561286,0.0462112696062323,0.428242524893364,1.73787997117032,1.46142995544163,-0.083484460501424,-0.977685420120512,0.518456480420229,1.77885043148906,0.461217300664786,0.00179192839122908,-0.225228959753106,-0.616217815397284,-0.697510536269603,-0.102935554016703,0.934888463383259]},\"columns\":[{\"id\":\"replicate\",\"name\":\"replicate\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"id\",\"name\":\"id\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"Z\",\"name\":\"Z\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"0.403539547\",\"-1.081359560\",\"-0.745394517\",\"-0.162359896\",\"-0.804857739\",\"-0.439984282\",\"0.229021083\",\"-0.180020470\",\"-1.755799630\",\"-1.388599160\",\"0.125032315\",\"-0.689956337\",\"0.584096511\",\"0.451655620\",\"-0.945607352\",\"1.063968712\",\"-0.164732652\",\"-0.584421992\",\"0.913655048\",\"0.972396971\",\"1.259603737\",\"0.600482389\",\"0.744063902\",\"0.547360162\",\"-0.132018556\",\"-0.214131315\",\"-0.890305431\",\"0.273270542\",\"0.518996224\",\"0.907387353\",\"-0.755827574\",\"-1.498460808\",\"0.500904730\",\"-0.405345784\",\"-0.767057107\",\"0.046211270\",\"0.428242525\",\"1.737879971\",\"1.461429955\",\"-0.083484461\",\"-0.977685420\",\"0.518456480\",\"1.778850431\",\"0.461217301\",\"0.001791928\",\"-0.225228960\",\"-0.616217815\",\"-0.697510536\",\"-0.102935554\",\"0.934888463\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}}],\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"pageSizeOptions\":[10,25,50,100],\"paginationType\":\"numbers\",\"showPagination\":true,\"showPageInfo\":true,\"minRows\":1,\"showSortable\":true,\"height\":\"auto\",\"theme\":{\"color\":\"#333333\",\"backgroundColor\":\"#FFFFFF\",\"stripedColor\":\"rgba(128,128,128,0.05)\",\"style\":{\"fontFamily\":\"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\"},\"headerStyle\":{\"borderTopStyle\":\"solid\",\"borderTopWidth\":\"2px\",\"borderTopColor\":\"#D3D3D3\",\"borderBottomStyle\":\"solid\",\"borderBottomWidth\":\"2px\",\"borderBottomColor\":\"#D3D3D3\"}},\"elementId\":\"mqasmdehcw\",\"dataKey\":\"e4e2242c5705b0735956014a48c45352\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[\"tag.attribs.columns.0.style\",\"tag.attribs.columns.1.style\",\"tag.attribs.columns.2.style\"],\"jsHooks\":[]}</script>\n</div>\n```\n\n:::\n:::\n\n\n\n### 3. Transforming to Multivariate GEV\n\nNow our data, $\\mathbf X$, is multivariate normal with dependence structure according to an AR(1) process, but marginally each $X_1$ is standard normal. To transform this data to a GEV dataset, we simply use the standard normal CDF on each $X_i$ to transform it to $[0, 1]$, then we use the GEV quantile function to transform that to a GEV distributed variable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmvnorm_to_gev <- function(mvnorm_data, gev_params) {\n  \n  mvnorm_data |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr:::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\ngev_data <- mvnorm_data |> \n  mvnorm_to_gev(gev_params = gev_params)\n\ngev_data |> \n  select(-mu, -sigma, -xi) |> \n  gt() |> \n  opt_interactive()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"zzmkebwgrd\" class=\".gt_table\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#zzmkebwgrd table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#zzmkebwgrd thead, #zzmkebwgrd tbody, #zzmkebwgrd tfoot, #zzmkebwgrd tr, #zzmkebwgrd td, #zzmkebwgrd th {\n  border-style: none;\n}\n\n#zzmkebwgrd p {\n  margin: 0;\n  padding: 0;\n}\n\n#zzmkebwgrd .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#zzmkebwgrd .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#zzmkebwgrd .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#zzmkebwgrd .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#zzmkebwgrd .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#zzmkebwgrd .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#zzmkebwgrd .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#zzmkebwgrd .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#zzmkebwgrd .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#zzmkebwgrd .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#zzmkebwgrd .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#zzmkebwgrd .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#zzmkebwgrd .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#zzmkebwgrd .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#zzmkebwgrd .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzmkebwgrd .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#zzmkebwgrd .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#zzmkebwgrd .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#zzmkebwgrd .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzmkebwgrd .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#zzmkebwgrd .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzmkebwgrd .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#zzmkebwgrd .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzmkebwgrd .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zzmkebwgrd .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zzmkebwgrd .gt_left {\n  text-align: left;\n}\n\n#zzmkebwgrd .gt_center {\n  text-align: center;\n}\n\n#zzmkebwgrd .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#zzmkebwgrd .gt_font_normal {\n  font-weight: normal;\n}\n\n#zzmkebwgrd .gt_font_bold {\n  font-weight: bold;\n}\n\n#zzmkebwgrd .gt_font_italic {\n  font-style: italic;\n}\n\n#zzmkebwgrd .gt_super {\n  font-size: 65%;\n}\n\n#zzmkebwgrd .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#zzmkebwgrd .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#zzmkebwgrd .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#zzmkebwgrd .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#zzmkebwgrd .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#zzmkebwgrd .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#zzmkebwgrd .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<div id=\"zzmkebwgrd\" class=\"reactable html-widget \" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"zzmkebwgrd\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"replicate\":[1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10],\"id\":[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],\"Z\":[0.403539546968351,-1.08135955962246,-0.745394516864418,-0.16235989607067,-0.80485773949381,-0.439984282237938,0.229021083306807,-0.180020470066276,-1.7557996304722,-1.38859916022831,0.125032315344734,-0.689956336897874,0.584096510995895,0.451655620321786,-0.945607352160775,1.06396871165744,-0.164732651579674,-0.584421991997708,0.913655047733595,0.972396970898358,1.25960373666065,0.600482388522512,0.744063902427303,0.547360162459707,-0.132018556488247,-0.214131314719595,-0.890305430895083,0.27327054212247,0.518996223878257,0.907387352660364,-0.755827573855755,-1.49846080781037,0.500904729727637,-0.405345784000656,-0.767057106561286,0.0462112696062323,0.428242524893364,1.73787997117032,1.46142995544163,-0.083484460501424,-0.977685420120512,0.518456480420229,1.77885043148906,0.461217300664786,0.00179192839122908,-0.225228959753106,-0.616217815397284,-0.697510536269603,-0.102935554016703,0.934888463383259],\"U\":[0.656724326018795,0.139768601605243,0.228016628812361,0.43551122502983,0.210450888880274,0.329974245630192,0.590573735264988,0.428568248968428,0.0395613137607606,0.0824773364383974,0.549751016435588,0.245110822942671,0.720422308969196,0.674241452907984,0.172174446441995,0.856328563131924,0.434577207910195,0.279468217135566,0.819550934292137,0.834573450847426,0.896093826554828,0.725907602707513,0.771581091843419,0.707934340664386,0.447484807130185,0.41522232824379,0.186650952889646,0.607677371096278,0.69811831273936,0.817899002420852,0.22487629112433,0.0670067839702118,0.691780913164105,0.342611678468984,0.221523781534029,0.518429069887524,0.665762720541394,0.958884017234447,0.928051257518566,0.466733166489656,0.164114967479337,0.697930091722737,0.962367856730879,0.677678644737928,0.500714875616134,0.410900580770385,0.26887538591961,0.242741673964621,0.459007059770782,0.825077108442584],\"y\":[8.71489946793197,4.03650576729152,4.8498738380583,6.55968601971496,4.69792469033086,5.69191829764836,7.98660569635812,6.50122370080338,2.68101206062457,3.37853250988576,7.58130666312823,4.99488148066993,9.53858757112097,8.92708078901809,4.3523179500181,12.1459593156581,6.55180412632675,5.28024974994101,11.2562587031681,11.5953379414632,13.4193786812384,9.61716988051371,10.3351335888582,9.36480011711469,6.66122929793066,6.38962030210518,4.48582047144659,8.1653755185154,9.23284125137817,11.2207095985896,4.82294879085583,3.16046932539105,9.14966612681499,5.79448734056992,4.79409520829399,7.28728562265466,8.82319231039965,17.1918863833899,14.8872847852914,6.82661911989531,4.27619184112288,9.23034867703143,17.5656979486439,8.96986219932198,7.12635875555807,6.35367972553918,5.19295158980949,4.97492820339579,6.75989242928078,11.377586171606]},\"columns\":[{\"id\":\"replicate\",\"name\":\"replicate\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"id\",\"name\":\"id\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"Z\",\"name\":\"Z\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"0.403539547\",\"-1.081359560\",\"-0.745394517\",\"-0.162359896\",\"-0.804857739\",\"-0.439984282\",\"0.229021083\",\"-0.180020470\",\"-1.755799630\",\"-1.388599160\",\"0.125032315\",\"-0.689956337\",\"0.584096511\",\"0.451655620\",\"-0.945607352\",\"1.063968712\",\"-0.164732652\",\"-0.584421992\",\"0.913655048\",\"0.972396971\",\"1.259603737\",\"0.600482389\",\"0.744063902\",\"0.547360162\",\"-0.132018556\",\"-0.214131315\",\"-0.890305431\",\"0.273270542\",\"0.518996224\",\"0.907387353\",\"-0.755827574\",\"-1.498460808\",\"0.500904730\",\"-0.405345784\",\"-0.767057107\",\"0.046211270\",\"0.428242525\",\"1.737879971\",\"1.461429955\",\"-0.083484461\",\"-0.977685420\",\"0.518456480\",\"1.778850431\",\"0.461217301\",\"0.001791928\",\"-0.225228960\",\"-0.616217815\",\"-0.697510536\",\"-0.102935554\",\"0.934888463\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"U\",\"name\":\"U\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"0.65672433\",\"0.13976860\",\"0.22801663\",\"0.43551123\",\"0.21045089\",\"0.32997425\",\"0.59057374\",\"0.42856825\",\"0.03956131\",\"0.08247734\",\"0.54975102\",\"0.24511082\",\"0.72042231\",\"0.67424145\",\"0.17217445\",\"0.85632856\",\"0.43457721\",\"0.27946822\",\"0.81955093\",\"0.83457345\",\"0.89609383\",\"0.72590760\",\"0.77158109\",\"0.70793434\",\"0.44748481\",\"0.41522233\",\"0.18665095\",\"0.60767737\",\"0.69811831\",\"0.81789900\",\"0.22487629\",\"0.06700678\",\"0.69178091\",\"0.34261168\",\"0.22152378\",\"0.51842907\",\"0.66576272\",\"0.95888402\",\"0.92805126\",\"0.46673317\",\"0.16411497\",\"0.69793009\",\"0.96236786\",\"0.67767864\",\"0.50071488\",\"0.41090058\",\"0.26887539\",\"0.24274167\",\"0.45900706\",\"0.82507711\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"y\",\"name\":\"y\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"8.714899\",\"4.036506\",\"4.849874\",\"6.559686\",\"4.697925\",\"5.691918\",\"7.986606\",\"6.501224\",\"2.681012\",\"3.378533\",\"7.581307\",\"4.994881\",\"9.538588\",\"8.927081\",\"4.352318\",\"12.145959\",\"6.551804\",\"5.280250\",\"11.256259\",\"11.595338\",\"13.419379\",\"9.617170\",\"10.335134\",\"9.364800\",\"6.661229\",\"6.389620\",\"4.485820\",\"8.165376\",\"9.232841\",\"11.220710\",\"4.822949\",\"3.160469\",\"9.149666\",\"5.794487\",\"4.794095\",\"7.287286\",\"8.823192\",\"17.191886\",\"14.887285\",\"6.826619\",\"4.276192\",\"9.230349\",\"17.565698\",\"8.969862\",\"7.126359\",\"6.353680\",\"5.192952\",\"4.974928\",\"6.759892\",\"11.377586\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}}],\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"pageSizeOptions\":[10,25,50,100],\"paginationType\":\"numbers\",\"showPagination\":true,\"showPageInfo\":true,\"minRows\":1,\"showSortable\":true,\"height\":\"auto\",\"theme\":{\"color\":\"#333333\",\"backgroundColor\":\"#FFFFFF\",\"stripedColor\":\"rgba(128,128,128,0.05)\",\"style\":{\"fontFamily\":\"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\"},\"headerStyle\":{\"borderTopStyle\":\"solid\",\"borderTopWidth\":\"2px\",\"borderTopColor\":\"#D3D3D3\",\"borderBottomStyle\":\"solid\",\"borderBottomWidth\":\"2px\",\"borderBottomColor\":\"#D3D3D3\"}},\"elementId\":\"zzmkebwgrd\",\"dataKey\":\"8ab26e3bdcba1d829590c49e5726f6f4\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[\"tag.attribs.columns.0.style\",\"tag.attribs.columns.1.style\",\"tag.attribs.columns.2.style\",\"tag.attribs.columns.3.style\",\"tag.attribs.columns.4.style\"],\"jsHooks\":[]}</script>\n</div>\n```\n\n:::\n:::\n\n\n## Checking the data\n\nLet's create a function that plots heat maps for each of the three representations of the data\n\n* Z: The multivariate normal\n* U: The multivariate uniform\n* y: The multivariate GEV\n\nWe want the color scales to be free, so we use `group_map()` and `wrap_plots()` instead of `facet_wrap()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- function(data) {\n  data |> \n    select(replicate, id, Z, U, y) |> \n    pivot_longer(c(-replicate, -id)) |> \n    mutate(\n      name = fct_relevel(name, \"Z\", \"U\", \"y\"),\n      name2 = name\n    ) |> \n    group_by(name) |> \n    group_map(\n      function(data, ...) {\n        data |> \n          ggplot(aes(id, replicate, fill = value)) +\n          geom_raster() +\n          coord_cartesian(expand = FALSE) +\n          theme(legend.position = \"none\") +\n          labs(\n            subtitle = data$name2\n          )\n      }\n    ) |> \n    wrap_plots() +\n    plot_layout(nrow = 1) +\n    plot_annotation(\n      title = \"Heatmaps of the three data representations\",\n      subtitle = \"Z: Normal | U: Uniform | y: GEV\"\n    )\n}\n```\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ngev_data |> \n  plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=100%}\n:::\n:::\n\n\n\nIt's nice to wrap this process in a single function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_data <- function(gev_params, n_replicate, rho) {\n  \n  make_AR_cor_matrix_1d(n_id = nrow(gev_params), rho = rho) |> \n    sample_gaussian_variables(n_replicates = n_replicate) |> \n    tidy_mvgauss() |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n```\n:::\n\n\nLet's see how the data look if we make it larger and increase the correlation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_id <- 40\nn_replicates <- 100\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\nd <- make_data(gev_params, n_replicates, rho = 0.95)\n```\n:::\n\n\n\nWe see that with higher neighbor correlations we get obvious horizontal stripes corresponding to a large amount of dependence within each replicate.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nd |> plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=100%}\n:::\n:::\n\n\n\n## Modeling\n\n[R scripts used for modeling](https://github.com/bgautijonsson/stan_experiments/blob/master/R/modeling.R)\n\nI wrote two different models in stan.\n\n1. A model that wraps the GEV margins into an AR(1) Gaussian copula\n2. A model that assumes i.i.d. GEV margins\n\n::: {.panel-tabset}\n\n### AR(1) Copula\n\n\n::: {.cell .column-page-inset output.var='model1'}\n\n```{.stan .cell-code}\nfunctions {\nreal gev_lpdf(real y, real mu, real sigma, real xi) {\nif (abs(xi) < 1e-10) {\nreal z = (y - mu) / sigma;\nreturn -log(sigma) - z - exp(-z);\n} else {\nreal z = 1 + xi * (y - mu) / sigma;\nif (z > 0) {\nreturn -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n} else {\nreject(\"Found incompatible GEV parameter values\");\n}\n}\n}\n\nreal normal_copula_prec_lpdf(vector U, matrix L) {\nint N = rows(U);\nvector[N] Z = inv_Phi(U);\nvector[N] mu = rep_vector(0, N);\nmatrix[N, N] I = diag_matrix(rep_vector(1, N));\n\nreturn multi_normal_prec_lpdf(Z | mu, L) - multi_normal_prec_lpdf(Z | mu, I);\n}\n}\n\ndata {\nint<lower = 0> n_replicate;\nint<lower = 0> n_id;\narray[n_replicate, n_id] real y;\narray[n_replicate, n_id] real y_test;\n}\n\nparameters {\nreal<lower = 0> mu;\nreal<lower = 0> sigma;\nreal<lower = 0, upper = 0.5> xi;\nreal<lower = -1, upper = 1> rho;\n}\n\nmodel {\n# Defining the precision matrix Q\nreal rho_scaler = pow(1 - rho^2, -1);\nreal diag_inside = rho^2 * rho_scaler;\nreal off_diag = -rho * rho_scaler;\nmatrix[n_id, n_id] Omega = diag_matrix(rep_vector(rho_scaler, n_id));\nOmega[2:(n_id - 1), 2:(n_id - 1)] = add_diag(Omega[2:(n_id - 1), 2:(n_id - 1)], diag_inside);\nfor (i in 1:n_id) {\nif (i > 1) {\nOmega[i, i - 1] = off_diag;\n}\nif (i < n_id) {\nOmega[i, i + 1] = off_diag;\n}\n}\n\n\nfor (i in 1:n_replicate) {\nvector[n_id] U;\nfor (j in 1:n_id) {\nU[j] = gev_cdf(y[i, j] | mu, sigma, xi);\ntarget += gev_lpdf(y[i, j] | mu, sigma, xi);\n}\ntarget += normal_copula_prec_lpdf(U | Omega);\n}\n}\n\ngenerated quantities {\nreal log_lik = 0;\n{\n# Creating Q inside brackets, since I don't want to include it in the model output\nreal rho_scaler = pow(1 - rho^2, -1);\nreal diag_inside = rho^2 * rho_scaler;\nreal off_diag = -rho * rho_scaler;\nmatrix[n_id, n_id] Omega = diag_matrix(rep_vector(rho_scaler, n_id));\nOmega[2:(n_id - 1), 2:(n_id - 1)] = add_diag(Omega[2:(n_id - 1), 2:(n_id - 1)], diag_inside);\nfor (i in 1:n_id) {\nif (i > 1) {\nOmega[i, i - 1] = off_diag;\n}\nif (i < n_id) {\nOmega[i, i + 1] = off_diag;\n}\n}\n\nfor (i in 1:n_replicate) {\nvector[n_id] U;\nfor (j in 1:n_id) {\nU[j] = gev_cdf(y_test[i, j] | mu, sigma, xi);\nlog_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n}\nlog_lik += normal_copula_prec_lpdf(U | Omega);\n}\n}\n}\n```\n:::\n\n\n### i.i.d.\n\n\n::: {.cell .column-page-inset output.var='model2'}\n\n```{.stan .cell-code}\nfunctions {\nreal gev_lpdf(real y, real mu, real sigma, real xi) {\nif (abs(xi) < 1e-10) {\nreal z = (y - mu) / sigma;\nreturn -log(sigma) - z - exp(-z);\n} else {\nreal z = 1 + xi * (y - mu) / sigma;\nif (z > 0) {\nreturn -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n} else {\nreject(\"Found incompatible GEV parameter values\");\n}\n}\n}\n}\n\ndata {\nint<lower = 0> n_replicate;\nint<lower = 0> n_id;\narray[n_replicate, n_id] real y;\narray[n_replicate, n_id] real y_test;\n}\n\nparameters {\nreal<lower = 0> mu;\nreal<lower = 0> sigma;\nreal<lower = 0, upper = 0.5> xi;\n}\n\ntransformed parameters {\n\n}\n\nmodel {\nfor (i in 1:n_replicate) {\nfor (j in 1:n_id) {\ntarget += gev_lpdf(y[i, j] | mu, sigma, xi);\n}\n}\n}\n\ngenerated quantities {\nreal log_lik = 0;\n{\nfor (i in 1:n_replicate) {\nfor (j in 1:n_id) {\nlog_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n}\n}\n}\n}\n\n```\n:::\n\n\n:::\n\n# Results\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/param_means.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/elppd.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Quarto/Results/Figures/diff_elppd.png){.column-page}\n\n\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/core-js-2.5.3/shim.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react-dom.min.js\"></script>\n<script src=\"../../site_libs/reactwidget-1.0.0/react-tools.js\"></script>\n<script src=\"../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/reactable-0.4.4/reactable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/reactable-binding-0.4.4/reactable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}